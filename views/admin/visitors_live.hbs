<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Visitors — Admin</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, sans-serif; margin:18px; color:#0b2545; }
    .card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(11,37,69,0.04); max-width:1100px; }
    .metrics { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .metric { background:#f5f9ff; border-radius:8px; padding:12px; min-width:160px; }
    .metric h3 { margin:0; font-size:0.9rem; color:#16365c; }
    .metric p { margin:6px 0 0 0; font-weight:700; font-size:1.4rem; }
    .top-paths { margin-top:8px; }
    .log { margin-top:12px; max-height:360px; overflow:auto; border:1px solid #eef4fb; border-radius:8px; padding:8px; background:#fcfeff; }
    .log-item { padding:6px 8px; border-bottom:1px dashed #eef5fb; font-size:0.95rem; color:#234; }
    .log-item:last-child { border-bottom:none; }
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">Live visitors (admin)</h2>
    <div class="metrics">
      <div class="metric">
        <h3>Total hits (today)</h3>
        <p id="totalHits">—</p>
      </div>
      <div class="metric">
        <h3>Unique visitors (today)</h3>
        <p id="uniqueToday">—</p>
      </div>
      <div style="flex:1; min-width:240px;">
        <h3 style="margin:0 0 6px 0">Top paths (today)</h3>
        <div id="topPaths" class="top-paths"></div>
      </div>
    </div>

    <h4 style="margin:10px 0 6px 0">Live log</h4>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <script>
    (function () {
      const evtSource = new EventSource('/admin/visitors/stream');
      const totalHitsEl = document.getElementById('totalHits');
      const uniqueTodayEl = document.getElementById('uniqueToday');
      const topPathsEl = document.getElementById('topPaths');
      const logEl = document.getElementById('log');

      evtSource.onmessage = function (e) {
        try {
          const data = JSON.parse(e.data);
          if (data.error) {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.textContent = `[${data.timestamp || new Date().toISOString()}] ERROR: ${data.error}`;
            logEl.prepend(item);
            return;
          }

          totalHitsEl.textContent = String(data.totalHits ?? '0');
          uniqueTodayEl.textContent = String(data.uniqueToday ?? '0');

          topPathsEl.innerHTML = '';
          if (Array.isArray(data.topPaths)) {
            data.topPaths.forEach(tp => {
              const el = document.createElement('div');
              el.style.fontSize = '0.95rem';
              el.textContent = `${tp._id} — ${tp.hits} hits`;
              topPathsEl.appendChild(el);
            });
          }

          // add a compact log entry
          const entry = document.createElement('div');
          entry.className = 'log-item';
          entry.textContent = `[${data.timestamp}] totalHits=${data.totalHits} unique=${data.uniqueToday}`;
          logEl.prepend(entry);

          // keep at most 200 lines
          while (logEl.children.length > 200) logEl.removeChild(logEl.lastChild);
        } catch (err) {
          console.error('SSE parse error', err);
        }
      };

      evtSource.onerror = function (err) {
        const entry = document.createElement('div');
        entry.className = 'log-item';
        entry.textContent = `[${new Date().toISOString()}] connection error — attempting reconnect...`;
        logEl.prepend(entry);
      };
    })();
  </script>
</body>
</html>
