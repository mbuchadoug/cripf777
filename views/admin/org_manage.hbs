{{!-- admin/org_manage.hbs --}}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manage {{org.name}}</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:18px;background:#fff;color:#111}
    main{max-width:980px;margin:0 auto}
    h1,h2{margin:14px 0}
    form.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;background:#0b6fb7;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    table td, table th{border:1px solid #e6e6e6;padding:8px;text-align:left}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .inline-form{display:inline-block;margin:0}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;background:#f1f1f1;color:#333}
    .badge-trial{background:#e8f5e9;color:#2e7d32;font-weight:700}
    .badge-paid{background:#fff3e0;color:#e65100;font-weight:700}
    .success{color:green}
    .error{color:red}
    .notice{margin-top:8px;color:#333}
    .panel{padding:12px;border-radius:8px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
    label.block{display:block;margin-bottom:8px}

    /* ---------- Tabs ---------- */
    .tabs{display:flex;gap:6px;margin-bottom:10px;position:sticky;top:0;background:#fafafa;padding:8px;z-index:10}
    .tab-btn{padding:6px 12px;border-radius:16px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:13px}
    .tab-btn.active{background:#0b6fb7;color:#fff;border-color:#0b6fb7}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* ---------- Scrollable members area ---------- */
    .members-scroll{max-height:420px;overflow-y:auto;border:1px solid #eee;border-radius:8px;background:#fff}
    .members-scroll table{margin-top:0}
    .members-scroll thead th{position:sticky;top:0;background:#f8f8f8;z-index:2}
    #memberSearch{position:sticky;top:52px;z-index:9;background:#fff}

    /* ---------- Scrollable invites ---------- */
    .invites-scroll{max-height:220px;overflow-y:auto;border:1px solid #eee;border-radius:8px;background:#fff;padding:8px}
    .invites-scroll ul{margin:0;padding-left:18px}

    /* ---------- Quiz Rules Table ---------- */
    .rules-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    .rules-table th{background:#f0f0f0;padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:0.3px;border-bottom:2px solid #ddd}
    .rules-table td{padding:10px 12px;border-bottom:1px solid #eee;vertical-align:middle}
    .rules-table tr:hover{background:#f8f8ff}
    .rules-table .empty-row td{text-align:center;color:#999;padding:24px}

    /* Filter pills */
    .filter-pills{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
    .filter-pill{padding:5px 12px;border-radius:16px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:12px;font-weight:600}
    .filter-pill.active{background:#0b6fb7;color:#fff;border-color:#0b6fb7}
    .filter-pill .count{opacity:0.7;margin-left:3px}

    /* Stats row */
    .rule-stats{display:flex;gap:12px;margin:10px 0;flex-wrap:wrap}
    .rule-stat{background:#f5f5f5;border:1px solid #e0e0e0;border-radius:8px;padding:8px 14px;font-size:13px}
    .rule-stat strong{font-size:16px;display:block}

    /* Admin nav links */
    .admin-links{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}
    .admin-links a{padding:8px 16px;border-radius:8px;background:#f5f5f5;border:1px solid #ddd;color:#333;text-decoration:none;font-size:13px;font-weight:600}
    .admin-links a:hover{background:#e8e8e8}
  </style>
</head>
<body>
  {{> navbar}}
  <main>
    <h1>Manage {{org.name}}</h1>

    {{!-- ===== ADMIN NAV LINKS (cripfcnt-home only) ===== --}}
    {{#if isHomeSchool}}
    <div class="admin-links">
      <a href="/admin/finance">üí∞ Finance Dashboard</a>
      <a href="/parent/dashboard">üëÅÔ∏è View Parent Dashboard</a>
    </div>
    {{/if}}

    <section>
      <h2>Invites</h2>
      <!-- AJAX invite form -->
      <form class="row" data-ajax="invite" method="post" action="/admin/orgs/{{org.slug}}/invite">
        <label style="flex:1">
          Email:
          <input name="email" placeholder="employee@example.com" required />
        </label>

        <label>
          Role:
          <select name="role">
            <option value="employee">Employee</option>
            <option value="manager">Manager</option>
          </select>
        </label>

        <button type="submit">Send Invite</button>
      </form>

      <div id="inviteFeedback" class="notice"></div>

     <h3 style="margin-top:16px">Existing Invites</h3>

<div class="invites-scroll">
  <ul id="invitesList">
    {{#each invites}}
      <li data-invite-id="{{this._id}}">
        <span class="small">{{this.email}}</span>
        <span class="muted"> | token: <code>{{this.token}}</code></span>
        <span class="badge">
          {{#if this.used}}Used{{else}}Pending{{/if}}
        </span>
        <span class="muted"> | created {{this.createdAt}}</span>
      </li>
    {{/each}}
  </ul>
</div>

    </section>

    <hr />

  <section>
  <h2>Members</h2>

  <div class="panel">
    <div class="tabs">
      {{#if groups.students.length}}
        <button class="tab-btn active" data-tab="students">
          Students ({{groups.students.length}})
        </button>
      {{/if}}

      {{#if groups.teachers.length}}
        <button class="tab-btn" data-tab="teachers">
          Teachers ({{groups.teachers.length}})
        </button>
      {{/if}}

      {{#if (or groups.staff.length (not isSchool))}}
        <button class="tab-btn" data-tab="staff">
          Staff ({{groups.staff.length}})
        </button>
      {{/if}}

      {{#if groups.admins.length}}
        <button class="tab-btn" data-tab="admins">
          Admins ({{groups.admins.length}})
        </button>
      {{/if}}
    </div>

    <input
      id="memberSearch"
      type="text"
      placeholder="Search by name, email, ID‚Ä¶"
      style="width:100%;padding:8px;margin:10px 0"
    />

    {{#if groups.students.length}}
   <div class="tab-content active" id="students">
  <div class="members-scroll">
    {{> members_table rows=groups.students isSchool=isSchool}}
  </div>
</div>

    {{/if}}

    {{#if groups.teachers.length}}
      <div class="tab-content" id="teachers">
        {{> members_table rows=groups.teachers isSchool=isSchool}}
      </div>
    {{/if}}

 {{#if (or groups.staff.length (not isSchool))}}
      <div class="tab-content" id="staff">
    {{> members_table rows=groups.staff isSchool=isSchool}}
      </div>
    {{/if}}

    {{#if groups.admins.length}}
      <div class="tab-content" id="admins">
       {{> members_table rows=groups.admins isSchool=isSchool}}
      </div>
    {{/if}}
  </div>
</section>


    <hr />

{{!-- ===== IMPORT SECTIONS ‚Äî HIDDEN FOR CRIPFCNT-HOME ===== --}}
{{#unless isHomeSchool}}

{{#if (eq org.type "school")}}
<div class="panel">
  <h2>Import Students (CSV)</h2>

  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-students"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
      <code>studentId, firstName, lastName, grade</code>
    </p>

    <button class="btn primary">Upload CSV</button>
  </form>
</div>
{{/if}}

{{#if (eq org.type "school")}}

<div class="panel">
  <h2>Import Teachers (CSV)</h2>
  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-teachers"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
      <code>email, firstName, lastName</code>
    </p>

    <button class="btn primary">Upload Teachers</button>
  </form>
</div>

<div class="panel">
  <h2>Import School Admins (CSV)</h2>
  <p class="muted small">
    School admins manage <strong>this school only</strong> (not platform admins).
  </p>

  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-admins"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
<code>adminId, firstName, lastName, role</code>

    </p>

    <button class="btn primary">Upload School Admins</button>
  </form>
</div>

{{/if}}
{{/unless}}

{{!-- ===== MODULES SECTION ‚Äî HIDDEN FOR CRIPFCNT-HOME ===== --}}
{{#unless isHomeSchool}}
    <section>
      <h2>Modules</h2>
      <a href="/admin/orgs/{{org.slug}}/modules">Manage Modules</a>
      {{#if modules.length}}
        <div style="margin-top:10px" class="small">
          Modules: {{#each modules}}<span class="badge" style="margin-right:6px">{{this.title}} ({{this.slug}})</span>{{/each}}
        </div>
      {{else}}
        <p class="muted small">No modules defined yet.</p>
      {{/if}}
    </section>

    <hr/>
{{/unless}}

{{!-- ===== ASSIGN QUIZ SECTION ‚Äî HIDDEN FOR CRIPFCNT-HOME ===== --}}
{{#unless isHomeSchool}}
    <section>
  
     <div class="panel">
       <form id="assignForm" method="post" action="/admin/orgs/{{org.slug}}/assign-quiz">

   {{#if (eq org.type "school")}}

<label class="block">
  Assign to:
  <select id="targetRole" name="targetRole" required>
    <option value="student">Students (by grade)</option>
    <option value="teacher">Teachers (all teachers)</option>
  </select>
</label>

<label class="block" id="gradeWrap">
  Grade:
  <select id="gradeSelect" name="grade">
    <option value="">-- select grade --</option>
    <option value="1">Grade 1</option>
    <option value="2">Grade 2</option>
    <option value="3">Grade 3</option>
    <option value="4">Grade 4</option>
    <option value="5">Grade 5</option>
    <option value="6">Grade 6</option>
    <option value="7">Grade 7</option>
  </select>
</label>

{{/if}}

         <p>Select members to assign a quiz for the chosen module. This creates an exam instance per selected user.</p>

         <label class="block">
           Module:
      <select id="modules" name="modules" multiple size="6" required>
  {{#each modules}}
    <option value="{{this.slug}}">
      {{this.title}} ({{this.slug}})
    </option>
  {{/each}}
</select>

<p class="muted small">
  Hold Ctrl / Cmd to select multiple modules
</p>

         </label>

{{#unless isSchool}}
<label class="block">
  Users:
  <select id="userIds" name="userIds" multiple size="6" required>

    {{!-- STAFF --}}
    {{#each groups.staff}}
      {{#if this.user}}
        <option value="{{this.user._id}}">
          {{this.user.email}} (staff)
        </option>
      {{/if}}
    {{/each}}

    {{!-- TEACHERS --}}
    {{#each groups.teachers}}
      {{#if this.user}}
        <option value="{{this.user._id}}">
          {{this.user.email}} (teacher)
        </option>
      {{/if}}
    {{/each}}

  </select>
  <p class="muted small">Hold Ctrl/Cmd to select multiple users.</p>
</label>
{{/unless}}



         <label class="block">
           <input type="checkbox" id="usePassage" name="usePassage" value="1" /> Assign a specific passage (passage quiz)
         </label>

         <label class="block" id="passageWrap" style="display:none">
           Passage to assign:
           <select id="passageSelect" name="passageId">
             <option value="">-- choose passage --</option>
             {{#if passages}}
               {{#each passages}}
                 <option value="{{this._id}}" data-child-count="{{this.childCount}}" data-module="{{this.module}}">
                   {{this.title}} ({{this.childCount}} q) {{#if this.organization}} ‚Äî org{{/if}}
                 </option>
               {{/each}}
             {{/if}}
           </select>
           <div class="muted small">When a passage is selected the Count will be set to the passage's child question count.</div>
         </label>

         <label class="block">
           Count:
           <input id="count" name="count" type="number" min="1" max="100" value="20">
         </label>

         <label class="block">
           Expires (mins):
           <input id="expiresMinutes" name="expiresMinutes" type="number" min="5" max="1440" value="60">
         </label>

         <label class="block">
  Duration (mins):
  <input
    id="durationMinutes"
    name="durationMinutes"
    type="number"
    min="1"
    max="300"
    value="30"
    required
  >
  <div class="muted small">
    How long the learner has to complete the quiz once they start.
  </div>
</label>


         <div style="margin-top:8px">
           <button id="assignBtn" type="submit">Assign Quiz</button>
         </div>
       </form>

       <div id="assignResult" class="notice"></div>
     </div>

    </section>
{{/unless}}


{{!-- ===== BULK ASSIGN ALL QUIZZES ‚Äî FIXED FOR CRIPFCNT-SCHOOL ===== --}}
{{!-- Place this right after </section> of regular assign quiz, BEFORE the create passage section --}}

{{#if (eq org.slug "cripfcnt-school")}}
<hr style="margin:30px 0; border:1px solid #e0e0e0"/>

<section>
  <div class="panel" style="border:2px solid #28a745;background:#f0fff4">
    <h2 style="color:#28a745; margin-top:0">üöÄ Bulk Assign ALL Quizzes</h2>
    
    <div style="background:#fff3cd; padding:12px; border-radius:6px; margin-bottom:16px">
      <strong>‚ö° Quick Assign:</strong> Assign all <strong>{{passages.length}} quizzes</strong> to selected members at once.
      <br>
      <span class="muted small">Each member will get their own exam instance for every quiz.</span>
    </div>

    <form id="bulkAssignForm" method="POST">
      
      <label class="block">
        <strong>Assign to:</strong>
        <select id="bulkTargetType" name="targetType" required style="width:100%; max-width:300px">
          <option value="all">All Members ({{groups.staff.length}} staff)</option>
          <option value="specific">Specific Users (select manually)</option>
        </select>
      </label>

      <label class="block" id="bulkUserWrap" style="display:none; margin-top:12px">
        <strong>Select Users:</strong>
        <select id="bulkUserIds" name="userIds" multiple size="10" style="width:100%">
          {{!-- Staff/Employees --}}
          {{#each groups.staff}}
            {{#if this.user}}
              <option value="{{this.user._id}}">
                üë§ {{this.user.displayName}} ({{this.user.email}})
              </option>
            {{/if}}
          {{/each}}
          
          {{!-- Teachers if any --}}
          {{#if groups.teachers.length}}
            <optgroup label="Teachers">
              {{#each groups.teachers}}
                {{#if this.user}}
                  <option value="{{this.user._id}}">
                    üë®‚Äçüè´ {{this.user.displayName}} ({{this.user.email}})
                  </option>
                {{/if}}
              {{/each}}
            </optgroup>
          {{/if}}
          
          {{!-- Admins --}}
          {{#if groups.admins.length}}
            <optgroup label="Admins">
              {{#each groups.admins}}
                {{#if this.user}}
                  <option value="{{this.user._id}}">
                    ‚≠ê {{this.user.displayName}} ({{this.user.email}})
                  </option>
                {{/if}}
              {{/each}}
            </optgroup>
          {{/if}}
        </select>
        <p class="muted small">Hold Ctrl/Cmd to select multiple users.</p>
      </label>

      <label class="block" style="margin-top:12px">
        <strong>Duration per quiz (minutes):</strong>
        <input
          name="durationMinutes"
          type="number"
          min="5"
          max="300"
          value="30"
          required
          style="width:100%; max-width:150px"
        >
        <div class="muted small">
          How long learners have to complete each quiz once started.
        </div>
      </label>

      <label class="block" style="margin-top:12px">
        <input type="checkbox" id="previewOnly" name="previewOnly" value="1" checked />
        <strong>Preview only</strong> (don't create, just show calculation)
      </label>

      <div style="margin-top:16px; padding:16px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px">
        <strong>‚ö†Ô∏è Warning:</strong> This will create <strong>{{passages.length}} exam instances per user</strong>.
        <br>
        <div class="muted small" style="margin-top:6px">
          <strong>Example calculations:</strong><br>
          ‚Ä¢ 1 user √ó {{passages.length}} quizzes = <strong>{{passages.length}}</strong> exam instances<br>
          ‚Ä¢ 5 users √ó {{passages.length}} quizzes = <strong>{{math passages.length "*" 5}}</strong> exam instances<br>
          ‚Ä¢ All staff ({{groups.staff.length}}) √ó {{passages.length}} quizzes = <strong>{{math passages.length "*" groups.staff.length}}</strong> exam instances
        </div>
      </div>

      <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap">
        <button 
          type="submit" 
          style="background:#28a745; color:#fff; font-size:16px; padding:14px 28px; border:none; border-radius:8px; cursor:pointer; font-weight:800"
        >
          üì¶ Bulk Assign All Quizzes
        </button>
        <button 
          type="button"
          onclick="document.getElementById('bulkAssignForm').reset(); document.getElementById('bulkAssignResult').innerHTML = ''; document.getElementById('previewOnly').checked = true;"
          style="background:#6c757d; color:#fff; font-size:16px; padding:14px 28px; border:none; border-radius:8px; cursor:pointer"
        >
          Clear Form
        </button>
      </div>
    </form>

    <div id="bulkAssignResult" class="notice" style="margin-top:16px"></div>
  </div>
</section>

<script>
(function() {
  // ===== BULK ASSIGN FORM LOGIC =====
  const bulkTargetType = document.getElementById('bulkTargetType');
  const bulkUserWrap = document.getElementById('bulkUserWrap');
  const bulkForm = document.getElementById('bulkAssignForm');

  // Toggle user selection based on target type
  if (bulkTargetType) {
    bulkTargetType.addEventListener('change', () => {
      const val = bulkTargetType.value;
      bulkUserWrap.style.display = val === 'specific' ? 'block' : 'none';
    });
  }

  // Form submission
  if (bulkForm) {
    bulkForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();

      const formData = new FormData(bulkForm);
      const targetType = formData.get('targetType');
      const durationMinutes = parseInt(formData.get('durationMinutes')) || 30;
      const previewOnly = formData.get('previewOnly') === '1';

      const payload = {
        targetType,
        durationMinutes,
        previewOnly
      };

      // Handle specific users
      if (targetType === 'specific') {
        const select = document.getElementById('bulkUserIds');
        payload.userIds = Array.from(select.selectedOptions).map(o => o.value);
        
        if (!payload.userIds.length) {
          document.getElementById('bulkAssignResult').innerHTML = 
            '<div class="error" style="color:#c00; padding:12px; background:#ffe6e6; border-radius:6px">‚ùå Please select at least one user.</div>';
          return;
        }
      }

      const resultDiv = document.getElementById('bulkAssignResult');
      resultDiv.innerHTML = '<div style="color:#007bff; padding:12px; background:#e7f3ff; border-radius:6px">‚è≥ Processing... This may take a minute...</div>';

      try {
        const resp = await fetch('/admin/orgs/cripfcnt-school/bulk-assign-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();

        if (!resp.ok) {
          resultDiv.innerHTML = `
            <div class="error" style="color:#c00; padding:12px; background:#ffe6e6; border-radius:6px">
              <strong>‚ùå Failed:</strong> ${data.error || 'Unknown error'}
              ${data.detail ? `<br><small>${data.detail}</small>` : ''}
            </div>
          `;
          return;
        }

        if (data.preview) {
          // Preview mode result
          resultDiv.innerHTML = `
            <div class="success" style="padding:16px; background:#d4edda; border:2px solid #28a745; border-radius:8px">
              <strong>üìä Preview Calculation:</strong><br><br>
              
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin:12px 0">
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#28a745">${data.usersCount}</div>
                  <div style="color:#666; font-size:13px">Users</div>
                </div>
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#007bff">${data.quizzesCount}</div>
                  <div style="color:#666; font-size:13px">Quizzes</div>
                </div>
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#ffc107">${data.totalInstances}</div>
                  <div style="color:#666; font-size:13px">Total Instances</div>
                </div>
              </div>

              <div style="margin-top:12px; padding:12px; background:#fff; border-radius:6px">
                <strong>Settings:</strong><br>
                ‚Ä¢ Duration: ${data.durationMinutes} minutes per quiz<br>
                ‚Ä¢ Total study time: ~${Math.ceil(data.totalInstances * data.durationMinutes / 60)} hours per user<br>
                ‚Ä¢ Database size: ~${Math.ceil(data.totalInstances * 2 / 1000)} MB
              </div>

              <div style="margin-top:12px; color:#666; font-size:13px">
                ‚úÖ Uncheck "Preview only" and submit again to create these exam instances.
              </div>
            </div>
          `;
        } else {
          // Actual creation result
          resultDiv.innerHTML = `
            <div class="success" style="padding:16px; background:#d4edda; border:2px solid #28a745; border-radius:8px">
              <strong>‚úÖ Bulk Assignment Complete!</strong><br><br>
              
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin:12px 0">
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#28a745">${data.totalCreated}</div>
                  <div style="color:#666; font-size:13px">Instances Created</div>
                </div>
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#007bff">${data.usersCount}</div>
                  <div style="color:#666; font-size:13px">Users</div>
                </div>
                <div style="text-align:center; padding:12px; background:#fff; border-radius:6px">
                  <div style="font-size:32px; font-weight:800; color:#ffc107">${data.quizzesCount}</div>
                  <div style="color:#666; font-size:13px">Quizzes Each</div>
                </div>
              </div>

              ${data.errors && data.errors.length > 0 ? `
                <div style="margin-top:12px; padding:12px; background:#fff3cd; border-radius:6px">
                  <strong>‚ö†Ô∏è Warning:</strong> ${data.errors.length} instances failed to create.
                  Check server logs for details.
                </div>
              ` : ''}

              <div style="margin-top:16px">
                <a 
                  href="/org/cripfcnt-school/dashboard" 
                  style="display:inline-block; background:#007bff; color:#fff; padding:10px 20px; border-radius:6px; text-decoration:none; font-weight:600"
                >
                  View Dashboard ‚Üí
                </a>
              </div>
            </div>
          `;
          
          // Reset form but keep preview checked
          bulkForm.reset();
          document.getElementById('previewOnly').checked = true;
        }

      } catch (err) {
        console.error('[bulk assign]', err);
        resultDiv.innerHTML = `
          <div class="error" style="color:#c00; padding:12px; background:#ffe6e6; border-radius:6px">
            <strong>‚ùå Network Error:</strong> ${err.message}<br>
            <small>Please check your connection and try again.</small>
          </div>
        `;
      }
    });
  }
})();
</script>
{{/if}}

{{!-- ===== CREATE PASSAGE SECTION ‚Äî NOW AVAILABLE FOR ALL ORGS INCLUDING CRIPFCNT-HOME ===== --}}
<section>
     <div class="panel">
       <h3>Create Passage Quiz (for this organization)</h3>
       <p class="muted">Paste passage text, then paste the child questions (each block separated by a blank line). The created passage will be saved with <code>organization</code> set to this company.</p>

       <form id="createPassageForm" method="post" action="/admin/orgs/{{org.slug}}/passages">
         <label class="block">
           Title (short):
           <input id="passageTitle" name="title" placeholder="Passage title (e.g. Responsibility passage 1)" required>
         </label>

         <label class="block">
           Module:
           <select id="passageModule" name="module" required>
             {{#each modules}}
               <option value="{{this.slug}}">{{this.title}} ({{this.slug}})</option>
             {{/each}}
           </select>
         </label>

         <label class="block">
           Passage text:
           <textarea id="passageText" name="passage" rows="6" style="width:100%" placeholder="Paste the passage here..." required></textarea>
         </label>

         <label class="block">
           Child questions (plain text, same format as Import): 
           <textarea id="passageQuestions" name="questions" rows="8" style="width:100%" placeholder="Question line\n a) option\n b) option\nCorrect Answer: a\n\nNext question..." required></textarea>
         </label>

         <div>
           <button type="submit">Create Passage Quiz</button>
         </div>
       </form>

       <div id="createPassageResult" class="notice"></div>
     </div>
</section>


{{!-- ===== QUIZ RULES ‚Äî CRIPFCNT-HOME ONLY (REDESIGNED) ===== --}}
{{#if isHomeSchool}}
<hr/>

<section class="panel">
  <h2>üè† Home School ‚Äì Quiz Rules</h2>
  <p class="muted small">
    These rules auto-assign quizzes when a parent adds a child.
  </p>

  {{!-- QUICK STATS --}}
  <div class="rule-stats" id="ruleStats"></div>

  {{!-- CREATE FORM --}}
  <div class="panel" style="background:#fff; margin:12px 0;">
    <h3 style="margin-top:0;">‚ûï Create New Rule</h3>
    <form method="POST" action="/admin/orgs/{{org.slug}}/quiz-rules" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">

      <label class="block">
        Grade
        <select name="grade" required>
          <option value="1">Grade 1</option>
          <option value="2">Grade 2</option>
          <option value="3">Grade 3</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
          <option value="7">Grade 7</option>
        </select>
      </label>

      <label class="block">
        Subject
        <select name="subject">
          <option value="math">Math</option>
          <option value="english">English</option>
          <option value="science">Science</option>
          <option value="responsibility">Responsibility</option>
          <option value="generalKnowledge">General Knowledge</option>
        </select>
      </label>

      <label class="block">
        Module
        <select name="module">
          {{#each modules}}
            <option value="{{slug}}">{{title}}</option>
          {{/each}}
        </select>
      </label>

     <label class="block">
  Quizzes (select multiple)
  <select name="quizQuestionId" multiple size="10" required>
    {{#if quizzes.length}}
      {{#each quizzes}}
        <option value="{{_id}}" data-subject="{{subject}}">
          {{text}} ({{module}})
        </option>
      {{/each}}
    {{else}}
      <option disabled>No quizzes found</option>
    {{/if}}
  </select>

  <p class="muted small">Hold Ctrl/Cmd to select multiple quizzes.</p>
</label>


      <label class="block">
        Question count
        <input name="questionCount" type="number" value="10" />
      </label>

      <label class="block">
        Duration (mins)
        <input name="durationMinutes" type="number" value="30" />
      </label>

      <label class="block">
        Type
        <select name="quizType">
          <option value="trial">Trial</option>
          <option value="paid">Paid</option>
        </select>
      </label>

      <div style="display:flex; align-items:end;">
        <button style="width:100%;">Create Quiz Rule</button>
      </div>
    </form>
  </div>

  <hr/>

  {{!-- FILTER PILLS --}}
  <h3>üìã Existing Rules</h3>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
    <input
      type="text"
      id="ruleSearch"
      placeholder="Search rules..."
      style="flex:1; min-width:200px; padding:8px; border:1px solid #ccc; border-radius:6px;"
    />
  </div>

  <div class="filter-pills" id="gradeFilters">
    <span class="filter-pill active" data-grade="all">All Grades</span>
    <span class="filter-pill" data-grade="1">G1</span>
    <span class="filter-pill" data-grade="2">G2</span>
    <span class="filter-pill" data-grade="3">G3</span>
    <span class="filter-pill" data-grade="4">G4</span>
    <span class="filter-pill" data-grade="5">G5</span>
    <span class="filter-pill" data-grade="6">G6</span>
    <span class="filter-pill" data-grade="7">G7</span>
  </div>

  <div class="filter-pills" id="typeFilters">
    <span class="filter-pill active" data-type="all">All Types</span>
    <span class="filter-pill" data-type="trial">üÜì Trial</span>
    <span class="filter-pill" data-type="paid">üí≥ Paid</span>
  </div>

  <div class="filter-pills" id="subjectFilters">
    <span class="filter-pill active" data-subject="all">All Subjects</span>
    <span class="filter-pill" data-subject="math">üìê Math</span>
    <span class="filter-pill" data-subject="english">üìñ English</span>
    <span class="filter-pill" data-subject="science">üî¨ Science</span>
    <span class="filter-pill" data-subject="responsibility">ü§ù Responsibility</span>
    <span class="filter-pill" data-subject="generalKnowledge">General Knowledge</span>
  </div>

  {{!-- RULES TABLE --}}
  <div style="overflow-x:auto;">
    <table class="rules-table" id="rulesTable">
      <thead>
        <tr>
          <th>Grade</th>
          <th>Subject</th>
          <th>Quiz Title</th>
          <th>Type</th>
          <th>Questions</th>
          <th>Duration</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {{#each quizRules}}
        <tr
          data-grade="{{grade}}"
          data-type="{{quizType}}"
          data-subject="{{subject}}"
        >
          <td><strong>Grade {{grade}}</strong></td>
          <td style="text-transform:capitalize;">{{subject}}</td>
         <td style="max-width:280px;">
  <div style="font-weight:600;">
    {{#if quizQuestionId}}
      <a
        href="/org/{{../org.slug}}/take-quiz?quizId={{quizQuestionId}}"
        target="_blank"
        rel="noopener"
        style="color:#0b6fb7; text-decoration:none;"
        title="Open this quiz in a new tab"
      >
        {{quizTitle}}
      </a>
    {{else}}
      {{quizTitle}}
    {{/if}}
  </div>

  <div class="muted small">Module: {{module}}</div>

  {{#if quizQuestionId}}
    <div style="margin-top:6px;">
      <a
        href="/org/{{../org.slug}}/take-quiz?quizId={{quizQuestionId}}"
        target="_blank"
        rel="noopener"
        class="badge"
        style="background:#e7f3ff; border:1px solid #bcdcff; color:#0b6fb7; text-decoration:none;"
      >
        ‚ñ∂ Test / Attempt
      </a>
    </div>
  {{/if}}
</td>

          <td>
            {{#if (eq quizType "trial")}}
              <span class="badge badge-trial">üÜì Trial</span>
            {{else}}
              <span class="badge badge-paid">üí≥ Paid</span>
            {{/if}}
          </td>
          <td>{{questionCount}}</td>
          <td>{{durationMinutes}} min</td>
          <td>
            {{#if enabled}}
              <span style="color:green;">‚óè Active</span>
            {{else}}
              <span style="color:#999;">‚óã Disabled</span>
            {{/if}}
          </td>
        </tr>
        {{/each}}

        {{#unless quizRules.length}}
        <tr class="empty-row">
          <td colspan="7">No quiz rules created yet.</td>
        </tr>
        {{/unless}}
      </tbody>
    </table>
  </div>

  <div id="ruleCount" class="muted small" style="margin-top:8px;"></div>
</section>
{{/if}}



{{!-- ===== QUIZ RULES ‚Äî CRIPFCNT-SCHOOL ONLY (NO GRADE/SUBJECT) ===== --}}
{{#if isCripSchool}}
<hr/>

<section class="panel">
  <h2>üè´ Crip School ‚Äì Employee Quiz Rules</h2>
  <p class="muted small">
    These rules auto-assign quizzes to employees.
    <br/>
    <strong>Trial</strong> rules apply on signup. <strong>Paid</strong> rules apply after Stripe upgrade.
  </p>

  {{!-- CREATE FORM (NO grade/subject) --}}
  <div class="panel" style="background:#fff; margin:12px 0;">
    <h3 style="margin-top:0;">‚ûï Create New Rule</h3>

    <form method="POST" action="/admin/orgs/{{org.slug}}/quiz-rules" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">

      <label class="block">
        Module
        <select name="module" required>
          {{#each modules}}
            <option value="{{slug}}">{{title}}</option>
          {{/each}}
        </select>
      </label>

  <label class="block">
  Quizzes (select multiple)
  <select name="quizQuestionId" multiple size="10" required>
    {{#each quizzes}}
      <option value="{{_id}}">{{text}} ({{module}})</option>
    {{/each}}
  </select>

  <p class="muted small">Hold Ctrl/Cmd to select multiple quizzes.</p>
</label>


      <label class="block">
        Question count
        <input name="questionCount" type="number" value="10" />
      </label>

      <label class="block">
        Duration (mins)
        <input name="durationMinutes" type="number" value="30" />
      </label>

      <label class="block">
        Type
        <select name="quizType" required>
          <option value="trial">Trial</option>
          <option value="paid">Paid</option>
        </select>
      </label>

      <div style="display:flex; align-items:end;">
        <button style="width:100%;">Create Quiz Rule</button>
      </div>

    </form>
  </div>

  <hr/>

  {{!-- LIST EXISTING RULES --}}
  <h3>üìã Existing Rules</h3>

  <div style="overflow-x:auto;">
    <table class="rules-table">
      <thead>
        <tr>
          <th>Module</th>
          <th>Quiz Title</th>
          <th>Type</th>
          <th>Questions</th>
          <th>Duration</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {{#each quizRules}}
        <tr data-type="{{quizType}}">
          <td><strong>{{module}}</strong></td>
          <td style="max-width:320px;">
            <div style="font-weight:600;">{{quizTitle}}</div>
          </td>
          <td>
            {{#if (eq quizType "trial")}}
              <span class="badge badge-trial">üÜì Trial</span>
            {{else}}
              <span class="badge badge-paid">üí≥ Paid</span>
            {{/if}}
          </td>
          <td>{{questionCount}}</td>
          <td>{{durationMinutes}} min</td>
          <td>
            {{#if enabled}}
              <span style="color:green;">‚óè Active</span>
            {{else}}
              <span style="color:#999;">‚óã Disabled</span>
            {{/if}}
          </td>
        </tr>
        {{/each}}

        {{#unless quizRules.length}}
        <tr class="empty-row">
          <td colspan="6">No quiz rules created yet.</td>
        </tr>
        {{/unless}}
      </tbody>
    </table>
  </div>
</section>
{{/if}}

  </main>

  {{!-- ===== SCRIPTS ‚Äî ONLY FOR NON-HOME ORGS ===== --}}
  {{#unless isHomeSchool}}
  <script>
    // helper: convert FormData -> object (handles multiple selects)
function formToObject(form) {
  const fd = new FormData(form);
  const obj = {};

  for (const [k, v] of fd.entries()) {
    if (obj[k] !== undefined) {
      if (!Array.isArray(obj[k])) obj[k] = [obj[k]];
      obj[k].push(v);
    } else {
      obj[k] = v;
    }
  }

  const moduleSelect = form.querySelector('[name="modules"]');
  if (moduleSelect) {
    obj.modules = Array.from(moduleSelect.selectedOptions).map(o => o.value);
  }

  const userSelect = form.querySelector('[name="userIds"]');
  if (userSelect) {
    obj.userIds = Array.from(userSelect.selectedOptions).map(o => o.value);
  }

  return obj;
}


    // hide/show passage selector + auto count
    const usePassageCb = document.getElementById('usePassage');
    const passageWrap = document.getElementById('passageWrap');
    const passageSelect = document.getElementById('passageSelect');
    const countInput = document.getElementById('count');
    const moduleSelect = document.getElementById('module');

    if (usePassageCb) {
    usePassageCb.addEventListener('change', () => {
      passageWrap.style.display = usePassageCb.checked ? 'block' : 'none';
      if (!usePassageCb.checked) {
        passageSelect.value = '';
        countInput.removeAttribute('disabled');
      }
    });
    }

    if (passageSelect) {
    passageSelect.addEventListener('change', () => {
      const opt = passageSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        countInput.removeAttribute('disabled');
        return;
      }
      const childCount = parseInt(opt.dataset.childCount || '0', 10) || 0;
      const passageModule = opt.dataset.module;
      if (childCount > 0) {
        countInput.value = childCount;
        countInput.setAttribute('disabled','disabled');
      } else {
        countInput.removeAttribute('disabled');
      }
      if (passageModule && moduleSelect) {
        for (const o of moduleSelect.options) {
          if (o.value === passageModule) {
            moduleSelect.value = passageModule;
            break;
          }
        }
      }
    });
    }

    // AJAX invite form
    document.querySelectorAll('form[data-ajax="invite"]').forEach(f => {
      f.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const url = f.action;
        const payload = formToObject(f);
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          const fb = document.getElementById('inviteFeedback');
          if (!resp.ok) {
            fb.innerHTML = '<span class="error">Invite failed: ' + (data.error || 'unknown') + '</span>';
            return;
          }
    const base =
  document.querySelector('base')?.href ||
  `${location.protocol}//${location.host}`;

const inviteLink = `${base}/org/join/${data.token}`;

fb.innerHTML = `
  <div class="success">
    <strong>Invite created ‚úÖ</strong><br><br>

    <strong>Invite link (for WhatsApp):</strong><br>
    <input
      type="text"
      value="${inviteLink}"
      readonly
      style="
        width:100%;
        padding:8px;
        margin-top:6px;
        border:1px solid #ccc;
        border-radius:6px;
        font-size:13px;
      "
      onclick="this.select()"
    />

    <div class="muted small" style="margin-top:6px">
      Copy this link and send it to the user on WhatsApp
    </div>

    <div class="muted small">
      Token: <code>${data.token}</code>
    </div>
  </div>
`;


          const ul = document.getElementById('invitesList');
          const li = document.createElement('li');
          li.innerHTML = `${payload.email} | token: <code>${data.token}</code> ‚Äî <span class="badge">Pending</span>`;
          ul.prepend(li);
          f.reset();
        } catch (e) {
          console.error(e);
          document.getElementById('inviteFeedback').innerHTML = '<span class="error">Invite failed (network)</span>';
        }
      });
    });

    // Member action buttons (promote/remove/demote)
    document.querySelectorAll('form[data-ajax="member"]').forEach(f => {
      f.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const url = f.action;
        const payload = formToObject(f);
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          const fb = document.getElementById('memberFeedback');
          if (!resp.ok) {
            fb.innerHTML = '<span class="error">Action failed: ' + (data.error || 'unknown') + '</span>';
            return;
          }
          fb.innerHTML = '<span class="success">Action: ' + (data.action || 'ok') + '</span>';
          const row = f.closest('tr');
          if (data.action === 'removed') {
            if (row) row.remove();
          } else if (data.action === 'promoted' || data.action === 'demoted') {
            if (row) {
              const roleCell = row.querySelector('.roleCell');
              if (roleCell) roleCell.textContent = data.role || (data.action === 'demoted' ? 'employee' : 'manager');
            }
          }
        } catch (e) {
          console.error(e);
          document.getElementById('memberFeedback').innerHTML = '<span class="error">Action failed (network)</span>';
        }
      });
    });

    // Assign Quiz (AJAX)
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
    assignForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const form = ev.currentTarget;
  const url = form.action;

  const payload = formToObject(form);
  const isSchool = "{{org.type}}" === "school";

if (isSchool) {
  if (payload.targetRole === "student" && !payload.grade) {
    document.getElementById('assignResult').innerHTML =
      '<span class="error">Please select a grade.</span>';
    return;
  }
  delete payload.userIds;
}
 else {
    if (!Array.isArray(payload.userIds) || !payload.userIds.length) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Please select at least one user.</span>';
      return;
    }
  }

  if (usePassageCb && usePassageCb.checked) {
    const sel = passageSelect.selectedOptions[0];
    if (!sel || !sel.value) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Please choose a passage to assign.</span>';
      return;
    }
    payload.passageId = sel.value;
    payload.count = parseInt(sel.dataset.childCount || payload.count || '1', 10) || 1;
  }

  document.getElementById('assignResult').textContent = 'Assigning...';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();

    if (!resp.ok) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Assign failed: ' + (data.error || 'unknown') + '</span>';
      return;
    }

    document.getElementById('assignResult').innerHTML =
      '<span class="success">Assigned ' +
      (data.assigned ? data.assigned.length : 0) +
      ' .</span>';

  } catch (e) {
    console.error(e);
    document.getElementById('assignResult').innerHTML =
      '<span class="error">Assign failed (network)</span>';
  }
});
    }

    // Create Passage Quiz (AJAX)
    const createPassageForm = document.getElementById('createPassageForm');
    if (createPassageForm) {
    createPassageForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const url = form.action;
      const payload = formToObject(form);
      document.getElementById('createPassageResult').textContent = 'Creating passage...';
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) {
          document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed: ' + (data.error || 'unknown') + '</span>';
          return;
        }
        document.getElementById('createPassageResult').innerHTML = '<span class="success">Passage created.</span>';
        if (data.passage && data.passage._id && passageSelect) {
          const opt = document.createElement('option');
          opt.value = data.passage._id;
          opt.textContent = (data.passage.title || 'Passage') + ' (' + (data.passage.childCount || 0) + ' q)';
          opt.dataset.childCount = data.passage.childCount || 0;
          opt.dataset.module = data.passage.module || '';
          passageSelect.appendChild(opt);
          usePassageCb.checked = true;
          passageWrap.style.display = 'block';
          passageSelect.value = data.passage._id;
          passageSelect.dispatchEvent(new Event('change'));
        }
        form.reset();
      } catch (e) {
        console.error(e);
        document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed (network)</span>';
      }
    });
    }

  </script>
  {{/unless}}

  {{!-- ===== CREATE PASSAGE SCRIPT ‚Äî NOW FOR ALL ORGS ===== --}}
  <script>
    // Create Passage Quiz (AJAX) - Works for all orgs including cripfcnt-home
    const createPassageForm = document.getElementById('createPassageForm');
    if (createPassageForm) {
    createPassageForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const url = form.action;
      
      function formToObject(form) {
        const fd = new FormData(form);
        const obj = {};
        for (const [k, v] of fd.entries()) {
          obj[k] = v;
        }
        return obj;
      }
      
      const payload = formToObject(form);
      document.getElementById('createPassageResult').textContent = 'Creating passage...';
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) {
          document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed: ' + (data.error || 'unknown') + '</span>';
          return;
        }
        document.getElementById('createPassageResult').innerHTML = '<span class="success">‚úÖ Passage created successfully! Created ' + (data.passage?.childCount || 0) + ' questions.</span>';
        form.reset();
      } catch (e) {
        console.error(e);
        document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed (network)</span>';
      }
    });
    }
  </script>

  {{!-- ===== COMMON SCRIPTS (ALL ORGS) ===== --}}
  <script>
 document.querySelectorAll('.set-password-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const userId = form.dataset.userId;
    const password = form.querySelector('input[name="password"]').value;
    const role = form.dataset.role;

    if (!password || password.length < 4) {
      alert("Password must be at least 4 characters");
      return;
    }

  let endpoint;

if (role === "teacher") {
  endpoint = `/admin/orgs/{{org.slug}}/teachers/${userId}/password`;
} else if (role === "student") {
  endpoint = `/admin/orgs/{{org.slug}}/students/${userId}/password`;
} else {
  endpoint = `/admin/orgs/{{org.slug}}/admins/${userId}/password`;
}

    try {
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || "Failed to set password");
        return;
      }

      alert("‚úÖ Password set successfully");
      form.reset();
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  });
});

</script>
<script>
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  function activateFirstTab() {
    const firstBtn = tabButtons[0];
    if (!firstBtn) return;
    const target = firstBtn.dataset.tab;
    firstBtn.classList.add("active");
    document.getElementById(target)?.classList.add("active");
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(target)?.classList.add("active");
    });
  });

  activateFirstTab();
</script>


<script>
  const searchInput = document.getElementById("memberSearch");
  if (searchInput) {
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    document
      .querySelectorAll(".tab-content.active tbody tr")
      .forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? "" : "none";
      });
  });
  }
</script>


<script>
  const roleSelect = document.getElementById("targetRole");
  const gradeWrap = document.getElementById("gradeWrap");

  if (roleSelect && gradeWrap) {
    roleSelect.addEventListener("change", () => {
      gradeWrap.style.display =
        roleSelect.value === "student" ? "block" : "none";
    });
  }
</script>

{{!-- ===== QUIZ RULES FILTER SCRIPT ‚Äî HOME ONLY ===== --}}
{{#if isHomeSchool}}
<script>
(function() {
  const table = document.getElementById('rulesTable');
  if (!table) return;

  const rows = Array.from(table.querySelectorAll('tbody tr[data-grade]'));
  const searchBox = document.getElementById('ruleSearch');
  const countEl = document.getElementById('ruleCount');
  const statsEl = document.getElementById('ruleStats');

  let activeGrade = 'all';
  let activeType = 'all';
  let activeSubject = 'all';

  // Build stats
  const totalRules = rows.length;
  const trialRules = rows.filter(r => r.dataset.type === 'trial').length;
  const paidRules = rows.filter(r => r.dataset.type === 'paid').length;
  const grades = new Set(rows.map(r => r.dataset.grade));

  if (statsEl) {
    statsEl.innerHTML = `
      <div class="rule-stat"><strong>${totalRules}</strong> Total Rules</div>
      <div class="rule-stat"><strong>${trialRules}</strong> Trial</div>
      <div class="rule-stat"><strong>${paidRules}</strong> Paid</div>
      <div class="rule-stat"><strong>${grades.size}</strong> Grades Covered</div>
    `;
  }

  function filterRows() {
    const q = (searchBox?.value || '').toLowerCase();
    let visible = 0;

    rows.forEach(row => {
      const matchGrade = activeGrade === 'all' || row.dataset.grade === activeGrade;
      const matchType = activeType === 'all' || row.dataset.type === activeType;
      const matchSubject = activeSubject === 'all' || row.dataset.subject === activeSubject;
      const matchSearch = !q || row.textContent.toLowerCase().includes(q);

      const show = matchGrade && matchType && matchSubject && matchSearch;
      row.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (countEl) {
      countEl.textContent = `Showing ${visible} of ${totalRules} rules`;
    }
  }

  // Grade filter pills
  document.querySelectorAll('#gradeFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('#gradeFilters .filter-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      activeGrade = pill.dataset.grade;
      filterRows();
    });
  });

  // Type filter pills
  document.querySelectorAll('#typeFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('#typeFilters .filter-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      activeType = pill.dataset.type;
      filterRows();
    });
  });

  // Subject filter pills
  document.querySelectorAll('#subjectFilters .filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('#subjectFilters .filter-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      activeSubject = pill.dataset.subject;
      filterRows();
    });
  });

  // Search
  if (searchBox) {
    searchBox.addEventListener('input', filterRows);
  }

  // Initial
  filterRows();
})();
</script>

<script>
  // Subject ‚Üí quiz filter for create form
  const subjectSelect = document.querySelector(
    'form[action$="/quiz-rules"] select[name="subject"]'
  );
  const quizSelect = document.querySelector(
    'form[action$="/quiz-rules"] select[name="quizQuestionId"]'
  );

  if (subjectSelect && quizSelect) {
   function filterQuizzesBySubject() {
  const subject = subjectSelect.value;

  Array.from(quizSelect.options).forEach(opt => {
    if (!opt.dataset.subject) return;

    const show = opt.dataset.subject === subject;
    opt.style.display = show ? '' : 'none';

    // ‚úÖ CRITICAL FIX: unselect hidden options
    if (!show) opt.selected = false;
  });

  // ‚úÖ Properly reset MULTI-SELECT
  quizSelect.selectedIndex = -1;
}


    subjectSelect.addEventListener('change', filterQuizzesBySubject);
    filterQuizzesBySubject();
  }
</script>
{{/if}}

{{!-- ===== INVITE AJAX ‚Äî HOME ORG (since the non-home script block has it too) ===== --}}
{{#if isHomeSchool}}
<script>
  function formToObject(form) {
    const fd = new FormData(form);
    const obj = {};
    for (const [k, v] of fd.entries()) {
      if (obj[k] !== undefined) {
        if (!Array.isArray(obj[k])) obj[k] = [obj[k]];
        obj[k].push(v);
      } else {
        obj[k] = v;
      }
    }
    return obj;
  }

  document.querySelectorAll('form[data-ajax="invite"]').forEach(f => {
    f.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const url = f.action;
      const payload = formToObject(f);
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        const fb = document.getElementById('inviteFeedback');
        if (!resp.ok) {
          fb.innerHTML = '<span class="error">Invite failed: ' + (data.error || 'unknown') + '</span>';
          return;
        }
        const base = document.querySelector('base')?.href || `${location.protocol}//${location.host}`;
        const inviteLink = `${base}/org/join/${data.token}`;
        fb.innerHTML = `<div class="success"><strong>Invite created ‚úÖ</strong><br><br><strong>Invite link:</strong><br><input type="text" value="${inviteLink}" readonly style="width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px;font-size:13px;" onclick="this.select()"/><div class="muted small" style="margin-top:6px">Copy this link and send it to the user on WhatsApp</div></div>`;
        const ul = document.getElementById('invitesList');
        const li = document.createElement('li');
        li.innerHTML = `${payload.email} | token: <code>${data.token}</code> ‚Äî <span class="badge">Pending</span>`;
        ul.prepend(li);
        f.reset();
      } catch (e) {
        console.error(e);
        document.getElementById('inviteFeedback').innerHTML = '<span class="error">Invite failed (network)</span>';
      }
    });
  });
</script>
{{/if}}

</body>
</html>
