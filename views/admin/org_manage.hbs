{{!-- admin/org_manage.hbs --}}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manage {{org.name}}</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:18px;background:#fff;color:#111}
    main{max-width:980px;margin:0 auto}
    h1,h2{margin:14px 0}
    form.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;background:#0b6fb7;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    table td, table th{border:1px solid #e6e6e6;padding:8px;text-align:left}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .inline-form{display:inline-block;margin:0}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;background:#f1f1f1;color:#333}
    .success{color:green}
    .error{color:red}
    .notice{margin-top:8px;color:#333}
    .panel{padding:12px;border-radius:8px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
    label.block{display:block;margin-bottom:8px}

    /* ---------- Tabs ---------- */
.tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  position: sticky;
  top: 0;
  background: #fafafa;
  padding: 8px;
  z-index: 10;
}

.tab-btn {
  padding: 6px 12px;
  border-radius: 16px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 13px;
}

.tab-btn.active {
  background: #0b6fb7;
  color: #fff;
  border-color: #0b6fb7;
}

/* ---------- Tab Content ---------- */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* ---------- Scrollable members area ---------- */
.members-scroll {
  max-height: 420px;      /* ðŸ‘ˆ KEY: stops massive scrolling */
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 8px;
  background: #fff;
}

/* ---------- Table polish ---------- */
.members-scroll table {
  margin-top: 0;
}

.members-scroll thead th {
  position: sticky;
  top: 0;
  background: #f8f8f8;
  z-index: 2;
}

/* ---------- Search ---------- */
#memberSearch {
  position: sticky;
  top: 52px;
  z-index: 9;
  background: #fff;
}


/* ---------- Scrollable invites ---------- */
.invites-scroll {
  max-height: 220px;        /* adjust if needed */
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 8px;
  background: #fff;
  padding: 8px;
}

.invites-scroll ul {
  margin: 0;
  padding-left: 18px;
}


  </style>
</head>
<body>
  {{> navbar}}
  <main>
    <h1>Manage {{org.name}}</h1>
  


    <section>
      <h2>Invites</h2>
      <!-- AJAX invite form -->
      <form class="row" data-ajax="invite" method="post" action="/admin/orgs/{{org.slug}}/invite">
        <label style="flex:1">
          Email:
          <input name="email" placeholder="employee@example.com" required />
        </label>

        <label>
          Role:
          <select name="role">
            <option value="employee">Employee</option>
            <option value="manager">Manager</option>
          </select>
        </label>

        <button type="submit">Send Invite</button>
      </form>

      <div id="inviteFeedback" class="notice"></div>

     <h3 style="margin-top:16px">Existing Invites</h3>

<div class="invites-scroll">
  <ul id="invitesList">
    {{#each invites}}
      <li data-invite-id="{{this._id}}">
        <span class="small">{{this.email}}</span>
        <span class="muted"> | token: <code>{{this.token}}</code></span>
        <span class="badge">
          {{#if this.used}}Used{{else}}Pending{{/if}}
        </span>
        <span class="muted"> | created {{this.createdAt}}</span>
      </li>
    {{/each}}
  </ul>
</div>

    </section>

    <hr />

  <section>
  <h2>Members</h2>

  <div class="panel">
    <div class="tabs">
      {{#if groups.students.length}}
        <button class="tab-btn active" data-tab="students">
          Students ({{groups.students.length}})
        </button>
      {{/if}}

      {{#if groups.teachers.length}}
        <button class="tab-btn" data-tab="teachers">
          Teachers ({{groups.teachers.length}})
        </button>
      {{/if}}

      {{#if (or groups.staff.length (not isSchool))}}
        <button class="tab-btn" data-tab="staff">
          Staff ({{groups.staff.length}})
        </button>
      {{/if}}

      {{#if groups.admins.length}}
        <button class="tab-btn" data-tab="admins">
          Admins ({{groups.admins.length}})
        </button>
      {{/if}}
    </div>

    <input
      id="memberSearch"
      type="text"
      placeholder="Search by name, email, IDâ€¦"
      style="width:100%;padding:8px;margin:10px 0"
    />

    {{#if groups.students.length}}
   <div class="tab-content active" id="students">
  <div class="members-scroll">
    {{> members_table rows=groups.students isSchool=isSchool}}
  </div>
</div>

    {{/if}}

    {{#if groups.teachers.length}}
      <div class="tab-content" id="teachers">
        {{> members_table rows=groups.teachers isSchool=isSchool}}
      </div>
    {{/if}}

 {{#if (or groups.staff.length (not isSchool))}}
      <div class="tab-content" id="staff">
    {{> members_table rows=groups.staff isSchool=isSchool}}
      </div>
    {{/if}}

    {{#if groups.admins.length}}
      <div class="tab-content" id="admins">
       {{> members_table rows=groups.admins isSchool=isSchool}}
      </div>
    {{/if}}
  </div>
</section>


    <hr />
{{#if (eq org.type "school")}}
<div class="panel">
  <h2>Import Students (CSV)</h2>

  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-students"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
      <code>studentId, firstName, lastName, grade</code>
    </p>

    <button class="btn primary">Upload CSV</button>
  </form>
</div>
{{/if}}

{{#if (eq org.type "school")}}

<div class="panel">
  <h2>Import Teachers (CSV)</h2>
  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-teachers"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
      <code>email, firstName, lastName</code>
    </p>

    <button class="btn primary">Upload Teachers</button>
  </form>
</div>

<div class="panel">
  <h2>Import School Admins (CSV)</h2>
  <p class="muted small">
    School admins manage <strong>this school only</strong> (not platform admins).
  </p>

  <form
    method="POST"
    action="/admin/orgs/{{org.slug}}/import-admins"
    enctype="multipart/form-data"
  >
    <input type="file" name="csv" accept=".csv" required />

    <p class="muted small">
      Required columns:
<code>adminId, firstName, lastName, role</code>

    </p>

    <button class="btn primary">Upload School Admins</button>
  </form>
</div>

{{/if}}

    <section>
      <h2>Modules</h2>
      <a href="/admin/orgs/{{org.slug}}/modules">Manage Modules</a>
      {{#if modules.length}}
        <div style="margin-top:10px" class="small">
          Modules: {{#each modules}}<span class="badge" style="margin-right:6px">{{this.title}} ({{this.slug}})</span>{{/each}}
        </div>
      {{else}}
        <p class="muted small">No modules defined yet.</p>
      {{/if}}
    </section>

    <hr/>

    <section>
  
     <div class="panel">
       <form id="assignForm" method="post" action="/admin/orgs/{{org.slug}}/assign-quiz">

   {{#if (eq org.type "school")}}

<label class="block">
  Assign to:
  <select id="targetRole" name="targetRole" required>
    <option value="student">Students (by grade)</option>
    <option value="teacher">Teachers (all teachers)</option>
  </select>
</label>

<label class="block" id="gradeWrap">
  Grade:
  <select id="gradeSelect" name="grade">
    <option value="">-- select grade --</option>
    <option value="1">Grade 1</option>
    <option value="2">Grade 2</option>
    <option value="3">Grade 3</option>
    <option value="4">Grade 4</option>
    <option value="5">Grade 5</option>
    <option value="6">Grade 6</option>
    <option value="7">Grade 7</option>
  </select>
</label>

{{/if}}

         <p>Select members to assign a quiz for the chosen module. This creates an exam instance per selected user.</p>

         <label class="block">
           Module:
      <select id="modules" name="modules" multiple size="6" required>
  {{#each modules}}
    <option value="{{this.slug}}">
      {{this.title}} ({{this.slug}})
    </option>
  {{/each}}
</select>

<p class="muted small">
  Hold Ctrl / Cmd to select multiple modules
</p>

         </label>

         <!--<label class="block">
           Users:
           <select id="userIds" name="userIds" multiple size="6" required>
             {{#each memberships}}
               {{#if this.user}}
                 <option value="{{this.user._id}}">{{this.user.email}} ({{this.role}})</option>
               {{/if}}
             {{/each}}
           </select>
           <p class="muted small">Hold Ctrl/Cmd to select multiple users.</p>
         </label>-->



{{#unless isSchool}}
<label class="block">
  Users:
  <select id="userIds" name="userIds" multiple size="6" required>

    {{!-- STAFF --}}
    {{#each groups.staff}}
      {{#if this.user}}
        <option value="{{this.user._id}}">
          {{this.user.email}} (staff)
        </option>
      {{/if}}
    {{/each}}

    {{!-- TEACHERS --}}
    {{#each groups.teachers}}
      {{#if this.user}}
        <option value="{{this.user._id}}">
          {{this.user.email}} (teacher)
        </option>
      {{/if}}
    {{/each}}

  </select>
  <p class="muted small">Hold Ctrl/Cmd to select multiple users.</p>
</label>
{{/unless}}



         <label class="block">
           <input type="checkbox" id="usePassage" name="usePassage" value="1" /> Assign a specific passage (passage quiz)
         </label>

         <label class="block" id="passageWrap" style="display:none">
           Passage to assign:
           <select id="passageSelect" name="passageId">
             <option value="">-- choose passage --</option>
             {{!-- server should provide `passages` array: each { _id, title, childCount, module, organization } --}}
             {{#if passages}}
               {{#each passages}}
                 <option value="{{this._id}}" data-child-count="{{this.childCount}}" data-module="{{this.module}}">
                   {{this.title}} ({{this.childCount}} q) {{#if this.organization}} â€” org{{/if}}
                 </option>
               {{/each}}
             {{/if}}
           </select>
           <div class="muted small">When a passage is selected the Count will be set to the passage's child question count.</div>
         </label>

         <label class="block">
           Count:
           <input id="count" name="count" type="number" min="1" max="100" value="20">
         </label>

         <label class="block">
           Expires (mins):
           <input id="expiresMinutes" name="expiresMinutes" type="number" min="5" max="1440" value="60">
         </label>

         <label class="block">
  Duration (mins):
  <input
    id="durationMinutes"
    name="durationMinutes"
    type="number"
    min="1"
    max="300"
    value="30"
    required
  >
  <div class="muted small">
    How long the learner has to complete the quiz once they start.
  </div>
</label>


         <div style="margin-top:8px">
           <button id="assignBtn" type="submit">Assign Quiz</button>
         </div>
       </form>

       <div id="assignResult" class="notice"></div>
     </div>

     <div class="panel">
       <h3>Create Passage Quiz (for this organization)</h3>
       <p class="muted">Paste passage text, then paste the child questions (each block separated by a blank line). The created passage will be saved with <code>organization</code> set to this company.</p>

       <form id="createPassageForm" method="post" action="/admin/orgs/{{org.slug}}/passages">
         <label class="block">
           Title (short):
           <input id="passageTitle" name="title" placeholder="Passage title (e.g. Responsibility passage 1)">
         </label>

         <label class="block">
           Module:
           <select id="passageModule" name="module">
             {{#each modules}}
               <option value="{{this.slug}}">{{this.title}} ({{this.slug}})</option>
             {{/each}}
           </select>
         </label>

         <label class="block">
           Passage text:
           <textarea id="passageText" name="passage" rows="6" style="width:100%" placeholder="Paste the passage here..." required></textarea>
         </label>

         <label class="block">
           Child questions (plain text, same format as Import): 
           <textarea id="passageQuestions" name="questions" rows="8" style="width:100%" placeholder="Question line\n a) option\n b) option\nCorrect Answer: a\n\nNext question..." required></textarea>
         </label>

         <div>
           <button type="submit">Create Passage Quiz</button>
         </div>
       </form>

       <div id="createPassageResult" class="notice"></div>
     </div>

    </section>

  </main>

  <script>
    // helper: convert FormData -> object (handles multiple selects)
function formToObject(form) {
  const fd = new FormData(form);
  const obj = {};

  for (const [k, v] of fd.entries()) {
    if (obj[k] !== undefined) {
      if (!Array.isArray(obj[k])) obj[k] = [obj[k]];
      obj[k].push(v);
    } else {
      obj[k] = v;
    }
  }

  // âœ… FORCE modules to always be array
  const moduleSelect = form.querySelector('[name="modules"]');
  if (moduleSelect) {
    obj.modules = Array.from(moduleSelect.selectedOptions).map(o => o.value);
  }

  // users
  const userSelect = form.querySelector('[name="userIds"]');
  if (userSelect) {
    obj.userIds = Array.from(userSelect.selectedOptions).map(o => o.value);
  }

  return obj;
}


    // hide/show passage selector + auto count
    const usePassageCb = document.getElementById('usePassage');
    const passageWrap = document.getElementById('passageWrap');
    const passageSelect = document.getElementById('passageSelect');
    const countInput = document.getElementById('count');
    const moduleSelect = document.getElementById('module');

    usePassageCb.addEventListener('change', () => {
      passageWrap.style.display = usePassageCb.checked ? 'block' : 'none';
      if (!usePassageCb.checked) {
        passageSelect.value = '';
        countInput.removeAttribute('disabled');
      }
    });

    passageSelect.addEventListener('change', () => {
      const opt = passageSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        countInput.removeAttribute('disabled');
        return;
      }
      const childCount = parseInt(opt.dataset.childCount || '0', 10) || 0;
      const passageModule = opt.dataset.module;
      if (childCount > 0) {
        countInput.value = childCount;
        countInput.setAttribute('disabled','disabled');
      } else {
        countInput.removeAttribute('disabled');
      }
      // if passage has module, set the module select to match (optional convenience)
      if (passageModule) {
        for (const o of moduleSelect.options) {
          if (o.value === passageModule) {
            moduleSelect.value = passageModule;
            break;
          }
        }
      }
    });

    // AJAX invite form
    document.querySelectorAll('form[data-ajax="invite"]').forEach(f => {
      f.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const url = f.action;
        const payload = formToObject(f);
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          const fb = document.getElementById('inviteFeedback');
          if (!resp.ok) {
            fb.innerHTML = '<span class="error">Invite failed: ' + (data.error || 'unknown') + '</span>';
            return;
          }
    const base =
  document.querySelector('base')?.href ||
  `${location.protocol}//${location.host}`;

const inviteLink = `${base}/org/join/${data.token}`;

fb.innerHTML = `
  <div class="success">
    <strong>Invite created âœ…</strong><br><br>

    <strong>Invite link (for WhatsApp):</strong><br>
    <input
      type="text"
      value="${inviteLink}"
      readonly
      style="
        width:100%;
        padding:8px;
        margin-top:6px;
        border:1px solid #ccc;
        border-radius:6px;
        font-size:13px;
      "
      onclick="this.select()"
    />

    <div class="muted small" style="margin-top:6px">
      Copy this link and send it to the user on WhatsApp
    </div>

    <div class="muted small">
      Token: <code>${data.token}</code>
    </div>
  </div>
`;


          const ul = document.getElementById('invitesList');
          const li = document.createElement('li');
          li.innerHTML = `${payload.email} | token: <code>${data.token}</code> â€” <span class="badge">Pending</span>`;
          ul.prepend(li);
          f.reset();
        } catch (e) {
          console.error(e);
          document.getElementById('inviteFeedback').innerHTML = '<span class="error">Invite failed (network)</span>';
        }
      });
    });

    // Member action buttons (promote/remove/demote)
    document.querySelectorAll('form[data-ajax="member"]').forEach(f => {
      f.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const url = f.action;
        const payload = formToObject(f);
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          const fb = document.getElementById('memberFeedback');
          if (!resp.ok) {
            fb.innerHTML = '<span class="error">Action failed: ' + (data.error || 'unknown') + '</span>';
            return;
          }
          fb.innerHTML = '<span class="success">Action: ' + (data.action || 'ok') + '</span>';
          const row = f.closest('tr');
          if (data.action === 'removed') {
            if (row) row.remove();
          } else if (data.action === 'promoted' || data.action === 'demoted') {
            if (row) {
              const roleCell = row.querySelector('.roleCell');
              if (roleCell) roleCell.textContent = data.role || (data.action === 'demoted' ? 'employee' : 'manager');
            }
          }
        } catch (e) {
          console.error(e);
          document.getElementById('memberFeedback').innerHTML = '<span class="error">Action failed (network)</span>';
        }
      });
    });

    // Assign Quiz (AJAX) â€” includes optional passageId when chosen
// Assign Quiz (AJAX) â€” includes optional passageId when chosen
document.getElementById('assignForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const form = ev.currentTarget;
  const url = form.action;

  const payload = formToObject(form);
  const isSchool = "{{org.type}}" === "school";

if (isSchool) {
  // âœ… Grade is ONLY required for students
  if (payload.targetRole === "student" && !payload.grade) {
    document.getElementById('assignResult').innerHTML =
      '<span class="error">Please select a grade.</span>';
    return;
  }

  // teachers don't use grade or userIds
  delete payload.userIds;
}
 else {
    if (!Array.isArray(payload.userIds) || !payload.userIds.length) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Please select at least one user.</span>';
      return;
    }
  }

  // Passage mode
  if (usePassageCb.checked) {
    const sel = passageSelect.selectedOptions[0];
    if (!sel || !sel.value) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Please choose a passage to assign.</span>';
      return;
    }
    payload.passageId = sel.value;
    payload.count = parseInt(sel.dataset.childCount || payload.count || '1', 10) || 1;
  }

  document.getElementById('assignResult').textContent = 'Assigning...';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();

    if (!resp.ok) {
      document.getElementById('assignResult').innerHTML =
        '<span class="error">Assign failed: ' + (data.error || 'unknown') + '</span>';
      return;
    }

    document.getElementById('assignResult').innerHTML =
      '<span class="success">Assigned ' +
      (data.assigned ? data.assigned.length : 0) +
      ' users.</span>';

  } catch (e) {
    console.error(e);
    document.getElementById('assignResult').innerHTML =
      '<span class="error">Assign failed (network)</span>';
  }
});

    // Create Passage Quiz (AJAX) â€” posts to /admin/orgs/:slug/passages
    document.getElementById('createPassageForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const url = form.action;
      const payload = formToObject(form);
      // payload keys: title, module, passage, questions
      document.getElementById('createPassageResult').textContent = 'Creating passage...';
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) {
          document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed: ' + (data.error || 'unknown') + '</span>';
          return;
        }
        document.getElementById('createPassageResult').innerHTML = '<span class="success">Passage created.</span>';
        // If server returns new passage metadata, append to passageSelect
        if (data.passage && data.passage._id) {
          const opt = document.createElement('option');
          opt.value = data.passage._id;
          opt.textContent = (data.passage.title || 'Passage') + ' (' + (data.passage.childCount || 0) + ' q)';
          opt.dataset.childCount = data.passage.childCount || 0;
          opt.dataset.module = data.passage.module || '';
          passageSelect.appendChild(opt);
          // select it automatically and toggle UI
          usePassageCb.checked = true;
          passageWrap.style.display = 'block';
          passageSelect.value = data.passage._id;
          passageSelect.dispatchEvent(new Event('change'));
        }
        form.reset();
      } catch (e) {
        console.error(e);
        document.getElementById('createPassageResult').innerHTML = '<span class="error">Create failed (network)</span>';
      }
    });

  </script>


  <script>
 document.querySelectorAll('.set-password-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const userId = form.dataset.userId;
    const password = form.querySelector('input[name="password"]').value;
    const role = form.dataset.role; // ðŸ‘ˆ ADD THIS

    if (!password || password.length < 4) {
      alert("Password must be at least 4 characters");
      return;
    }

    // ðŸ‘‡ CHOOSE ENDPOINT BASED ON ROLE
  let endpoint;

if (role === "teacher") {
  endpoint = `/admin/orgs/{{org.slug}}/teachers/${userId}/password`;
} else if (role === "student") {
  endpoint = `/admin/orgs/{{org.slug}}/students/${userId}/password`;
} else {
  endpoint = `/admin/orgs/{{org.slug}}/admins/${userId}/password`;
}


    try {
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || "Failed to set password");
        return;
      }

      alert("âœ… Password set successfully");
      form.reset();
    } catch (err) {
      console.error(err);
      alert("Network error");
    }
  });
});

</script>
<script>
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  function activateFirstTab() {
    const firstBtn = tabButtons[0];
    if (!firstBtn) return;

    const target = firstBtn.dataset.tab;

    firstBtn.classList.add("active");
    document.getElementById(target)?.classList.add("active");
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;

      tabButtons.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));

      btn.classList.add("active");
      document.getElementById(target)?.classList.add("active");
    });
  });

  // auto activate first available tab
  activateFirstTab();
</script>


<script>
  const searchInput = document.getElementById("memberSearch");

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();

    document
      .querySelectorAll(".tab-content.active tbody tr")
      .forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? "" : "none";
      });
  });
</script>


<script>
  const roleSelect = document.getElementById("targetRole");
  const gradeWrap = document.getElementById("gradeWrap");

  if (roleSelect && gradeWrap) {
    roleSelect.addEventListener("change", () => {
      gradeWrap.style.display =
        roleSelect.value === "student" ? "block" : "none";
    });
  }
</script>


</body>
</html>
