{{!-- views/admin/scoi_reports_list.hbs - ADMIN SCOI REPORTS VIEWER --}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCOI Reports Library | Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Work+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#6366F1;
      --success:#10B981;
      --warning:#F59E0B;
      --info:#3B82F6;
      --navy:#0F172A;
      --slate:#64748B;
      --white:#FFFFFF;
      --gray-50:#F8FAFC;
      --gray-100:#F1F5F9;
      --gray-200:#E2E8F0;
      
      --font-mono:'JetBrains Mono',monospace;
      --font-body:'Work Sans',system-ui,sans-serif;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:var(--font-body);
      background:var(--gray-50);
      color:var(--navy);
    }

    /* HEADER */
    .header{
      background:white;
      border-bottom:1px solid var(--gray-200);
      padding:20px 0;
      box-shadow:var(--shadow);
    }

    .header-container{
      max-width:1600px;
      margin:0 auto;
      padding:0 32px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .brand{font-weight:800;font-size:20px;color:var(--navy)}
    
    .nav-links{display:flex;gap:24px;align-items:center}
    .nav-link{
      color:var(--slate);
      text-decoration:none;
      font-weight:600;
      font-size:14px;
      transition:color 0.2s;
    }
    .nav-link:hover{color:var(--primary)}
    .nav-link.active{color:var(--primary)}

    /* CONTAINER */
    .container{
      max-width:1600px;
      margin:0 auto;
      padding:60px 32px;
    }

    /* PAGE HEADER */
    .page-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:40px;
      flex-wrap:wrap;
      gap:20px;
    }

    .header-left h1{
      font-size:42px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:8px;
    }

    .header-left p{
      font-size:16px;
      color:var(--slate);
    }

    .header-actions{
      display:flex;
      gap:12px;
    }

    .btn{
      padding:12px 24px;
      border-radius:10px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s;
      border:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .btn-primary{
      background:var(--primary);
      color:white;
      box-shadow:0 4px 12px rgba(99,102,241,0.3);
    }

    .btn-primary:hover{
      transform:translateY(-2px);
    }

    .btn-outline{
      background:transparent;
      border:2px solid var(--gray-200);
      color:var(--slate);
    }

    .btn-outline:hover{
      border-color:var(--primary);
      color:var(--primary);
    }

    /* FILTERS */
    .filters{
      background:white;
      padding:24px;
      border-radius:16px;
      box-shadow:var(--shadow);
      margin-bottom:32px;
      display:grid;
      grid-template-columns:2fr 1fr 1fr auto;
      gap:16px;
      align-items:end;
    }

    .filter-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .filter-label{
      font-size:13px;
      font-weight:700;
      color:var(--navy);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .filter-input{
      padding:10px 14px;
      border:2px solid var(--gray-200);
      border-radius:8px;
      font-family:var(--font-body);
      font-size:14px;
      color:var(--navy);
    }

    .filter-input:focus{
      outline:none;
      border-color:var(--primary);
    }

    /* STATS */
    .stats-bar{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:20px;
      margin-bottom:32px;
    }

    .stat-card{
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:var(--shadow);
      border-left:4px solid var(--primary);
    }

    .stat-value{
      font-size:32px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:6px;
    }

    .stat-label{
      font-size:13px;
      color:var(--slate);
      font-weight:600;
    }

    /* TABLE */
    .table-card{
      background:white;
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    thead{
      background:var(--gray-50);
    }

    th{
      padding:16px 20px;
      text-align:left;
      font-size:12px;
      font-weight:700;
      color:var(--slate);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    td{
      padding:20px;
      border-bottom:1px solid var(--gray-100);
      font-size:14px;
    }

    tbody tr{
      transition:background 0.2s;
    }

    tbody tr:hover{
      background:var(--gray-50);
    }

    .report-title{
      font-weight:700;
      color:var(--navy);
      margin-bottom:4px;
    }

    .report-meta{
      font-size:12px;
      color:var(--slate);
    }

    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
    }

    .badge-special{
      background:rgba(99,102,241,0.1);
      color:#4F46E5;
    }

    .badge-placement{
      background:rgba(16,185,129,0.1);
      color:#047857;
    }

    .badge-paid{
      background:rgba(16,185,129,0.1);
      color:#047857;
    }

    .badge-unpaid{
      background:rgba(245,158,11,0.1);
      color:#D97706;
    }

    .action-buttons{
      display:flex;
      gap:8px;
    }

    .btn-sm{
      padding:8px 14px;
      font-size:13px;
      border-radius:8px;
      font-weight:600;
    }

    /* EMPTY STATE */
    .empty-state{
      text-align:center;
      padding:80px 32px;
    }

    .empty-icon{
      font-size:64px;
      margin-bottom:20px;
      opacity:0.3;
    }

    .empty-title{
      font-size:24px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:12px;
    }

    .empty-text{
      font-size:15px;
      color:var(--slate);
      margin-bottom:24px;
    }

    /* RESPONSIVE */
    @media(max-width:1200px){
      .filters{grid-template-columns:1fr 1fr;gap:12px}
      .stats-bar{grid-template-columns:repeat(2,1fr)}
    }

    @media(max-width:768px){
      .filters{grid-template-columns:1fr}
      .stats-bar{grid-template-columns:1fr}
      .action-buttons{flex-direction:column}
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="header-container">
    <div class="brand">üèõÔ∏è SCOI Admin</div>
    <div class="nav-links">
      <a href="/admin" class="nav-link">Dashboard</a>
      <a href="/admin/scoi/reports" class="nav-link active">Reports Library</a>
      <a href="/admin/scoi/import" class="nav-link">Import</a>
      <a href="/admin/scoi/financials" class="nav-link">Financials</a>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-left">
      <h1>SCOI Reports Library</h1>
      <p>View, manage, and download all imported intelligence reports</p>
    </div>

    <div class="header-actions">
      <a href="/admin/scoi/import" class="btn btn-outline">
        üì§ Import New
      </a>
      <button onclick="generateAllPdfs()" class="btn btn-primary">
        üì• Generate All PDFs
      </button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-value">{{stats.total}}</div>
      <div class="stat-label">Total Reports</div>
    </div>

    <div class="stat-card" style="border-left-color:#10B981">
      <div class="stat-value">{{stats.placement}}</div>
      <div class="stat-label">Placement Audits</div>
    </div>

    <div class="stat-card" style="border-left-color:#6366F1">
      <div class="stat-value">{{stats.special}}</div>
      <div class="stat-label">Special Reports</div>
    </div>

    <div class="stat-card" style="border-left-color:#F59E0B">
      <div class="stat-value">{{stats.withPdf}}</div>
      <div class="stat-label">PDFs Generated</div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <div class="filter-group">
      <label class="filter-label">Search</label>
      <input 
        type="text" 
        class="filter-input" 
        id="searchInput"
        placeholder="Search by organization or event..."
      />
    </div>

    <div class="filter-group">
      <label class="filter-label">Type</label>
      <select class="filter-input" id="typeFilter">
        <option value="">All Types</option>
        <option value="placement">Placement Audits</option>
        <option value="special">Special Reports</option>
      </select>
    </div>

    <div class="filter-group">
      <label class="filter-label">PDF Status</label>
      <select class="filter-input" id="pdfFilter">
        <option value="">All</option>
        <option value="with-pdf">With PDF</option>
        <option value="no-pdf">No PDF</option>
      </select>
    </div>

    <button onclick="applyFilters()" class="btn btn-primary">
      üîç Filter
    </button>
  </div>

  <!-- TABLE -->
  {{#if reports.length}}
    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Report Details</th>
            <th>Type</th>
            <th>Assessment Window</th>
            <th>Status</th>
            <th>PDF</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportsTable">
          {{#each reports}}
            <tr data-type="{{this.auditKind}}" data-pdf="{{#if this.pdfUrl}}with-pdf{{else}}no-pdf{{/if}}">
              <td>
                <div class="report-title">{{this.subject.name}}</div>
                <div class="report-meta">
                  Author: {{this.author}} | 
                  Entity: {{this.subject.entityType}}
                </div>
              </td>

              <td>
                {{#if (eq this.auditKind "special")}}
                  <span class="badge badge-special">Special</span>
                {{else}}
                  <span class="badge badge-placement">Placement</span>
                {{/if}}
              </td>

              <td>{{this.assessmentWindow.label}}</td>

              <td>
                {{#if this.isPaid}}
                  <span class="badge badge-paid">‚úì Paid</span>
                {{else}}
                  <span class="badge badge-unpaid">Available</span>
                {{/if}}
              </td>

              <td>
                {{#if this.pdfUrl}}
                  <span style="color:var(--success)">‚úì Generated</span>
                {{else}}
                  <span style="color:var(--slate)">Not yet</span>
                {{/if}}
              </td>

              <td>
                <div class="action-buttons">
                  <a 
                    href="/admin/scoi/reports/{{this._id}}/view" 
                    target="_blank"
                    class="btn btn-outline btn-sm"
                  >
                    üëÅÔ∏è View
                  </a>

                  {{#if this.pdfUrl}}
                    <a 
                      href="{{this.pdfUrl}}" 
                      target="_blank"
                      class="btn btn-primary btn-sm"
                    >
                      üì• PDF
                    </a>
                  {{else}}
                    <button 
                      onclick="generatePdf('{{this._id}}')"
                      class="btn btn-primary btn-sm"
                    >
                      üìÑ Generate
                    </button>
                  {{/if}}
                </div>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

  {{else}}
    
    <div class="table-card">
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <div class="empty-title">No Reports Found</div>
        <div class="empty-text">
          Import SCOI reports to view and manage them here
        </div>
        <a href="/admin/scoi/import" class="btn btn-primary">
          üì§ Import Reports
        </a>
      </div>
    </div>

  {{/if}}

</main>

<!-- SCRIPTS -->
<script>
  // Filter function
  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const type = document.getElementById('typeFilter').value;
    const pdfStatus = document.getElementById('pdfFilter').value;

    const rows = document.querySelectorAll('#reportsTable tr');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const rowType = row.dataset.type;
      const rowPdf = row.dataset.pdf;

      const matchesSearch = !search || text.includes(search);
      const matchesType = !type || rowType === type;
      const matchesPdf = !pdfStatus || rowPdf === pdfStatus;

      row.style.display = (matchesSearch && matchesType && matchesPdf) ? '' : 'none';
    });
  }

  // Live search
  document.getElementById('searchInput')?.addEventListener('input', applyFilters);
  document.getElementById('typeFilter')?.addEventListener('change', applyFilters);
  document.getElementById('pdfFilter')?.addEventListener('change', applyFilters);

  // Generate single PDF
  async function generatePdf(auditId) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating...';

    try {
      const response = await fetch(`/admin/scoi/reports/${auditId}/generate-pdf`, {
        method: 'POST'
      });

      const data = await response.json();

      if (data.success) {
        alert('‚úÖ PDF generated successfully!');
        window.location.reload();
      } else {
        alert('‚ùå Failed to generate PDF: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.textContent = 'üìÑ Generate';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Failed to generate PDF');
      btn.disabled = false;
      btn.textContent = 'üìÑ Generate';
    }
  }

  // Generate all PDFs
  async function generateAllPdfs() {
    if (!confirm('Generate PDFs for all reports without PDFs? This may take a while.')) {
      return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating All...';

    try {
      const response = await fetch('/admin/scoi/reports/generate-all-pdfs', {
        method: 'POST'
      });

      const data = await response.json();

      if (data.success) {
        alert(`‚úÖ Generated ${data.generated} PDFs successfully!`);
        window.location.reload();
      } else {
        alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.textContent = 'üì• Generate All PDFs';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Failed to generate PDFs');
      btn.disabled = false;
      btn.textContent = 'üì• Generate All PDFs';
    }
  }
</script>

</body>
</html>
