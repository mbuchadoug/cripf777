<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{org.name}} | Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root{
      --gold:#D4AF37;
      --bg:#0b0b0b;
      --panel:#141414;
      --border:#222;
      --muted:#9aa3ad;
      --radius:12px;
    }

    body{
      font-family:system-ui, -apple-system, "Segoe UI", Arial;
      margin:0;
      background:#0b0b0b;
      color:#fff;
    }

    main{
      max-width:1200px;
      margin:30px auto;
      padding:0 20px;
    }

    h1{font-size:30px;margin-bottom:6px}
    h2{font-size:20px;margin:30px 0 12px;color:var(--gold)}
    h3{font-size:16px;margin:0}

    /* ====== PANELS ====== */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:18px;
    }

    /* ====== TRIAL UPGRADE BANNER ====== */
    .trial-banner{
      background:linear-gradient(135deg, #1a472a 0%, #0f5132 100%);
      border:2px solid var(--gold);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .trial-banner h3{
      color:var(--gold);
      margin:0 0 8px;
    }

    .trial-banner p{
      color:#ddd;
      margin:0;
      font-size:14px;
    }

    .upgrade-btn{
      background:var(--gold);
      color:#000;
      padding:12px 24px;
      border-radius:8px;
      font-weight:800;
      text-decoration:none;
      white-space:nowrap;
    }

    .upgrade-btn:hover{
      background:#c9a227;
    }

    /* ====== SEARCH & FILTER ====== */
    .search-panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:24px;
    }

    .search-grid{
      display:grid;
      grid-template-columns:1fr 1fr 1fr auto;
      gap:12px;
      align-items:end;
    }

    .search-group label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:600;
    }

    .search-group input,
    .search-group select{
      width:100%;
      padding:10px;
      background:#0b0b0b;
      border:1px solid var(--border);
      border-radius:8px;
      color:#fff;
      font-size:14px;
    }

    .search-group input:focus,
    .search-group select:focus{
      outline:2px solid var(--gold);
      border-color:var(--gold);
    }

    .search-btn{
      background:var(--gold);
      color:#000;
      padding:10px 20px;
      border:none;
      border-radius:8px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
    }

    .search-btn:hover{
      background:#c9a227;
    }

    .clear-btn{
      background:transparent;
      color:var(--muted);
      padding:10px 20px;
      border:1px solid var(--border);
      border-radius:8px;
      font-weight:600;
      text-decoration:none;
      font-size:14px;
      margin-left:8px;
      display:inline-block;
    }

    /* ====== GRID ====== */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }

    /* ====== MODULE / QUIZ CARDS ====== */
    .card{
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px;
      background:#111;
    }

    .card small{color:var(--muted)}

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:start;
      margin-bottom:10px;
    }

    .trial-badge{
      background:var(--gold);
      color:#000;
      padding:2px 8px;
      border-radius:4px;
      font-size:11px;
      font-weight:800;
    }

    .catalog-badge{
      background:#1e90ff;
      color:#fff;
      padding:2px 8px;
      border-radius:4px;
      font-size:11px;
      font-weight:800;
    }

    .topic-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }

    .topic-tag{
      background:rgba(212,175,55,0.15);
      color:var(--gold);
      padding:3px 8px;
      border-radius:4px;
      font-size:11px;
      font-weight:600;
    }

    .actions{
      margin-top:10px;
    }

    .actions a{
      color:var(--gold);
      font-size:14px;
      margin-right:12px;
      text-decoration:none;
    }

    .actions button{
      background:none;
      border:none;
      color:#c00;
      cursor:pointer;
      font-size:14px;
      padding:0;
    }

    /* ====== SCROLL AREAS ====== */
    .scroll-box{
      max-height:320px;
      overflow:auto;
      padding-right:6px;
    }

    .scroll-box::-webkit-scrollbar{
      width:6px;
    }
    .scroll-box::-webkit-scrollbar-thumb{
      background:#333;
      border-radius:10px;
    }

    /* ====== TAGS ====== */
    .tag{
      display:inline-block;
      padding:3px 8px;
      font-size:12px;
      border-radius:999px;
      background:#1f1f1f;
      color:var(--muted);
      margin-left:6px;
    }

    /* ====== ADMIN ====== */
    .admin a{
      background:#1e90ff;
      padding:6px 10px;
      border-radius:6px;
      font-size:14px;
      color:#fff;
      margin-right:10px;
      text-decoration:none;
    }

    @media(max-width:900px){
      .search-grid{
        grid-template-columns:1fr;
      }

      .trial-banner{
        flex-direction:column;
        gap:16px;
        text-align:center;
      }
    }
  </style>
</head>

<body>
  {{> navbar}}

  <main>

    {{#if showWelcome}}
    <div class="panel">
      <h3 style="color:var(--gold)">Welcome to CRIPFCnt üéì</h3>
      <p style="color:var(--muted);margin-top:6px">
        You've been enrolled into the Responsibility LMS. Navigate modules, quizzes,
        certificates and SCOI resources below.
      </p>
    </div>
    {{/if}}

    <!-- TRIAL UPGRADE BANNER -->
    {{#if showTrialBanner}}
    <div class="trial-banner">
      <div>
        <h3>üéØ Trial Account</h3>
        <p>You have {{trialQuizzesRemaining}} trial quizzes remaining. Complete them to unlock upgrade!</p>
      </div>
      {{#if canUpgrade}}
        <a href="/upgrade" class="upgrade-btn">Upgrade Now ‚Üí</a>
      {{/if}}
    </div>
    {{/if}}

 {{!-- ============================================ --}}
    {{!-- EMPLOYEE TRIAL BANNER (cripfcnt-school)      --}}
    {{!-- ============================================ --}}
    {{#if (and isCripfcntSchool (eq user.employeeSubscriptionStatus "trial"))}}
    {{#unless isAdmin}}
    <div class="trial-banner">
      <div>
        <h3>üéØ Employee Trial Account</h3>
        <p>
          Complete your {{employeeTrialTotal}} trial quizzes to unlock full access.
          Progress: {{employeeTrialCompleted}}/{{employeeTrialTotal}}
        </p>
      </div>
      {{#if canUpgradeEmployee}}
        <a href="/employee/upgrade" class="upgrade-btn">Upgrade to Full Access ‚Üí</a>
      {{/if}}
    </div>
    {{/unless}}
    {{/if}}

    <h1>
      {{#if (eq membership.role "student")}}
        {{org.name}} - Student Dashboard
      {{else if (eq membership.role "teacher")}}
        {{org.name}} - Teacher Dashboard
      {{else}}
        {{org.name}} Dashboard
      {{/if}}
    </h1>

{{!-- =============================== --}}
{{!-- MODE SWITCH: ORG ‚Üí PARENT       --}}
{{!-- =============================== --}}
<div class="panel" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
  <div>
    <strong style="color:var(--gold)">üë®‚Äçüë©‚Äçüëß Parent Mode</strong>
    <div style="color:var(--muted);font-size:13px;margin-top:4px">
      View your children‚Äôs learning dashboard
    </div>
  </div>

  <a
    href="/parent/dashboard"
    style="
      background:var(--gold);
      color:#000;
      padding:10px 18px;
      border-radius:8px;
      font-weight:800;
      text-decoration:none;
      white-space:nowrap;
    "
  >
    Switch to CRIPFCnt Jnr Academy ‚Üí
  </a>
</div>



    {{#if isAdmin}}
    <div class="admin panel">
      <a href="/admin/orgs/{{org.slug}}/manage">Manage Org</a>
      <a href="/admin/orgs/{{org.slug}}/attempts">View Attempts</a>
      <a href="/admin/orgs/{{org.slug}}/certificates">View Certificates</a>
      {{#if isCripfcntSchool}}
        <span style="color:var(--gold);margin-left:10px">
          üìö Showing all available quizzes
        </span>
      {{/if}}
    </div>
    {{/if}}

    <!-- ================= SEARCH & FILTER ================= -->
    {{#if isCripfcntSchool}}
    <div class="search-panel">
      <form id="searchForm" method="GET" action="/org/{{org.slug}}/dashboard">
        <div class="search-grid">
          
          <div class="search-group">
            <label for="searchQuery">Search Quizzes</label>
            <input 
              type="text" 
              id="searchQuery" 
              name="q" 
              value="{{searchQuery}}"
              placeholder="Search by title, keyword..."
            />
          </div>

          <div class="search-group">
            <label for="moduleFilter">Filter by Module</label>
            <select id="moduleFilter" name="module">
              <option value="">All Modules</option>
              <option value="consciousness" {{#if (eq moduleFilter "consciousness")}}selected{{/if}}>Consciousness</option>
              <option value="responsibility" {{#if (eq moduleFilter "responsibility")}}selected{{/if}}>Responsibility</option>
              <option value="interpretation" {{#if (eq moduleFilter "interpretation")}}selected{{/if}}>Interpretation</option>
              <option value="purpose" {{#if (eq moduleFilter "purpose")}}selected{{/if}}>Purpose</option>
              <option value="frequencies" {{#if (eq moduleFilter "frequencies")}}selected{{/if}}>Frequencies</option>
              <option value="civilization" {{#if (eq moduleFilter "civilization")}}selected{{/if}}>Civilization</option>
              <option value="negotiation" {{#if (eq moduleFilter "negotiation")}}selected{{/if}}>Negotiation</option>
              <option value="technology" {{#if (eq moduleFilter "technology")}}selected{{/if}}>Technology</option>
            </select>
          </div>

          <div class="search-group">
            <label for="topicFilter">Filter by Topic</label>
            <input 
              type="text" 
              id="topicFilter" 
              name="topic" 
              value="{{topicFilter}}"
              placeholder="e.g., placement, decision..."
            />
          </div>

          <div style="display:flex;gap:8px">
            <button type="submit" class="search-btn">Search</button>
            <a href="/org/{{org.slug}}/dashboard" class="clear-btn">Clear</a>
          </div>
        </div>
      </form>
    </div>
    {{/if}}

    <!-- ================= MODULES ================= -->
    {{#unless (eq membership.role "student")}}
    {{#unless isAdmin}}
    <h2>Modules</h2>
    <div class="grid">
      {{#each modules}}
        <div class="card">
          <h3>{{this.title}}</h3>
          <small>{{this.slug}}</small>
          <div class="actions" style="margin-top:8px">
            <a href="/org/{{../org.slug}}/modules/{{this.slug}}">Open</a>
          </div>
        </div>
      {{/each}}
    </div>
    {{/unless}}
    {{/unless}}

    <!-- ================= ASSIGNED QUIZZES ================= -->
    <h2>
      {{#if isAdmin}}
        {{#if isCripfcntSchool}}
          üìö Quiz Library
        {{else}}
          Assigned Quizzes
        {{/if}}
      {{else}}
        Assigned Quizzes
      {{/if}}
      {{#if searchQuery}}
        <span style="font-size:14px;color:var(--muted);font-weight:normal">
          (showing results for "{{searchQuery}}")
        </span>
      {{/if}}
    </h2>

    {{#if hasAssignedQuizzes}}
      {{#each quizzesByModule}}
        <div class="panel">
          <h3>{{@key}}</h3>

          <div class="scroll-box">
            {{#each this}}
              <div class="card" style="margin-top:10px">
                <div class="card-header">
                  <strong>{{quizTitle}}</strong>
                  <div>
                    {{#if isTrial}}
                      <span class="trial-badge">TRIAL</span>
                    {{/if}}
                    {{#if isAdminQuiz}}
                      <span class="catalog-badge">CATALOG</span>
                    {{/if}}
                  </div>
                </div>

                <span class="tag">{{questionCount}} questions</span>

                {{#if topics}}
                  <div class="topic-tags">
                    {{#each topics}}
                      <span class="topic-tag">{{this}}</span>
                    {{/each}}
                  </div>
                {{/if}}

                <div class="actions">
                  <a href="{{openUrl}}">
                    {{#if isAdminQuiz}}Take Quiz{{else}}Open quiz{{/if}}
                  </a>

                  {{#if ../../isAdmin}}
                    {{#unless isAdminQuiz}}
                      <form
                        method="POST"
                        action="/admin/orgs/{{../../org.slug}}/quizzes/{{assignmentId}}/delete"
                        style="display:inline"
                        onsubmit="return confirm('Delete this quiz?');"
                      >
                        <button>Delete</button>
                      </form>
                    {{/unless}}
                  {{/if}}
                </div>

                {{#unless isAdminQuiz}}
                  <small class="tag">Status: {{status}}</small>
                {{/unless}}
              </div>
            {{/each}}
          </div>
        </div>
      {{/each}}
    {{else}}
      <p>No quizzes found. {{#if searchQuery}}Try different search terms.{{else}}No quizzes available yet.{{/if}}</p>
    {{/if}}

    <!-- ================= HISTORY + CERTS ================= -->
    <div class="grid">
      <div class="panel">
        <h2>Quiz History</h2>
        <div class="scroll-box">
          {{#each attemptRows}}
            <div class="card" style="margin-bottom:10px">
              <strong>{{quizTitle}}</strong>

              <div>
                {{percentage}}%
                {{#if passed}}
                  <span class="tag">Passed</span>
                {{else}}
                  <span class="tag">Failed</span>
                {{/if}}
              </div>

              <div class="actions" style="margin-top:6px">
                <a href="/org/{{../org.slug}}/my-attempts/{{_id}}">
                  Review Attempt
                </a>
              </div>

              <small>{{finishedAt}}</small>
            </div>
          {{/each}}
        </div>
      </div>

      {{#if certRows.length}}
      <div class="panel">
        <h2>Certificates</h2>
        <div class="scroll-box">
          {{#each certRows}}
            <div class="card" style="margin-bottom:10px">
              <strong>{{quizTitle}}</strong>
              <div>{{percentage}}%</div>

              <a
                href="/admin/certificates/{{_id}}/download/pdf"
                target="_blank"
              >
                Download
              </a>
            </div>
          {{/each}}
        </div>
      </div>
      {{/if}}
    </div>

    <!-- ================= MARKETPLACE ================= -->
    {{#if isAdmin}}
    <h2>Marketplace</h2>
    <div class="panel">
      <strong>SCOI Audit Reports</strong>
      <div class="actions" style="margin-top:8px">
        <a href="/scoi">Browse Marketplace</a>
        <a href="/scoi/purchased">My Purchases</a>
      </div>
    </div>
    {{/if}}

  </main>
</body>
</html>
