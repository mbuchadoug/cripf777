{{!-- views/admin/scoi_financials.hbs - SCOI FINANCIAL DASHBOARD --}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCOI Financial Dashboard | Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Work+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#6366F1;
      --success:#10B981;
      --warning:#F59E0B;
      --info:#3B82F6;
      --navy:#0F172A;
      --slate:#64748B;
      --white:#FFFFFF;
      --gray-50:#F8FAFC;
      --gray-100:#F1F5F9;
      --gray-200:#E2E8F0;
      
      --font-mono:'JetBrains Mono',monospace;
      --font-body:'Work Sans',system-ui,sans-serif;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg:0 12px 32px rgba(0,0,0,0.12);
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:var(--font-body);
      background:var(--gray-50);
      color:var(--navy);
    }

    .header{
      background:white;
      border-bottom:1px solid var(--gray-200);
      padding:20px 0;
      box-shadow:var(--shadow);
    }

    .header-container{
      max-width:1600px;
      margin:0 auto;
      padding:0 32px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .brand{font-weight:800;font-size:20px;color:var(--navy)}
    
    .nav-links{display:flex;gap:24px;align-items:center}
    .nav-link{color:var(--slate);text-decoration:none;font-weight:600;font-size:14px}
    .nav-link:hover{color:var(--primary)}

    .container{max-width:1600px;margin:0 auto;padding:60px 32px}

    .page-header{margin-bottom:48px}
    .page-title{font-size:42px;font-weight:800;color:var(--navy);margin-bottom:12px}
    .page-subtitle{font-size:16px;color:var(--slate)}

    /* STATS GRID */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:24px;
      margin-bottom:40px;
    }

    .stat-card{
      background:white;
      padding:24px;
      border-radius:16px;
      box-shadow:var(--shadow);
      border-left:4px solid var(--primary);
    }

    .stat-label{
      font-size:13px;
      font-weight:700;
      color:var(--slate);
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:10px;
    }

    .stat-value{
      font-size:36px;
      font-weight:800;
      color:var(--navy);
      line-height:1;
      margin-bottom:8px;
    }

    .stat-change{
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .stat-change.positive{color:var(--success)}
    .stat-change.neutral{color:var(--slate)}

    /* CHARTS */
    .charts-grid{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:24px;
      margin-bottom:40px;
    }

    .chart-card{
      background:white;
      padding:28px;
      border-radius:16px;
      box-shadow:var(--shadow);
    }

    .chart-title{
      font-size:18px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:24px;
    }

    .chart-canvas{
      max-height:320px;
    }

    /* TABLE */
    .table-card{
      background:white;
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .table-header{
      padding:24px 28px;
      border-bottom:1px solid var(--gray-200);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .table-title{
      font-size:20px;
      font-weight:800;
      color:var(--navy);
    }

    .btn-export{
      padding:10px 20px;
      background:var(--primary);
      color:white;
      border:none;
      border-radius:10px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
    }

    .table-wrapper{
      overflow-x:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    thead{
      background:var(--gray-50);
    }

    th{
      padding:16px 24px;
      text-align:left;
      font-size:13px;
      font-weight:700;
      color:var(--slate);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    td{
      padding:20px 24px;
      border-bottom:1px solid var(--gray-100);
      font-size:14px;
    }

    tbody tr:hover{
      background:var(--gray-50);
    }

    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }

    .badge-success{
      background:rgba(16,185,129,0.1);
      color:#047857;
    }

    .badge-primary{
      background:rgba(99,102,241,0.1);
      color:#4F46E5;
    }

    /* RESPONSIVE */
    @media(max-width:1200px){
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .charts-grid{grid-template-columns:1fr}
    }

    @media(max-width:768px){
      .stats-grid{grid-template-columns:1fr}
      .page-title{font-size:32px}
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="header-container">
    <div class="brand">üèõÔ∏è SCOI Admin</div>
    <div class="nav-links">
      <a href="/admin" class="nav-link">Dashboard</a>
      <a href="/admin/scoi/import" class="nav-link">Import</a>
      <a href="/admin/scoi/financials" class="nav-link">Financials</a>
      <a href="/scoi" class="nav-link">Marketplace</a>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <h1 class="page-title">Financial Dashboard</h1>
    <p class="page-subtitle">
      Revenue analytics and transaction history for SCOI intelligence reports
    </p>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Revenue</div>
      <div class="stat-value">${{totalRevenue}}</div>
      <div class="stat-change neutral">All-time earnings</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">This Month</div>
      <div class="stat-value">${{monthlyRevenue}}</div>
      <div class="stat-change positive">‚Üë Current period</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Total Sales</div>
      <div class="stat-value">{{stats.totalSales}}</div>
      <div class="stat-change neutral">Reports sold</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Avg Order Value</div>
      <div class="stat-value">${{stats.avgOrderValue}}</div>
      <div class="stat-change neutral">Per transaction</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    
    <!-- REVENUE CHART -->
    <div class="chart-card">
      <h2 class="chart-title">üìà Monthly Revenue</h2>
      <canvas id="revenueChart" class="chart-canvas"></canvas>
    </div>

    <!-- TOP SELLERS -->
    <div class="chart-card">
      <h2 class="chart-title">üèÜ Top Selling Reports</h2>
      <canvas id="topSellersChart" class="chart-canvas"></canvas>
    </div>

  </div>

  <!-- TRANSACTIONS TABLE -->
  <div class="table-card">
    <div class="table-header">
      <h2 class="table-title">Recent Transactions</h2>
      <button class="btn-export" onclick="exportTransactions()">
        üì• Export CSV
      </button>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Report</th>
            <th>Customer</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {{#each purchases}}
            <tr>
              <td>{{formatDate this.createdAt}}</td>
              <td>
                <strong>{{this.auditId.subject.name}}</strong><br>
                <span style="font-size:12px;color:var(--slate)">
                  {{this.auditId.assessmentWindow.label}}
                </span>
              </td>
              <td>{{this.userId.email}}</td>
              <td>
                {{#if (eq this.auditId.auditClass "special_report")}}
                  <span class="badge badge-primary">Special</span>
                {{else}}
                  <span class="badge badge-success">Placement</span>
                {{/if}}
              </td>
              <td style="font-weight:700;font-family:var(--font-mono)">
                ${{math this.pricePaid "/" 100}}
              </td>
              <td>
                <span class="badge badge-success">‚úì Paid</span>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

</main>

<!-- SCRIPTS -->
<script>
  // Revenue by month data
  const revenueByMonth = {{{json revenueByMonth}}};
  
  // Convert to arrays for Chart.js
  const months = Object.keys(revenueByMonth).sort();
  const revenues = months.map(m => revenueByMonth[m] / 100);

  // Revenue Line Chart
  const revenueCtx = document.getElementById('revenueChart');
  new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: months.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
      }),
      datasets: [{
        label: 'Revenue ($)',
        data: revenues,
        borderColor: '#6366F1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: '#6366F1',
        pointBorderColor: '#FFFFFF',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {display: false},
        tooltip: {
          callbacks: {
            label: (ctx) => '$' + ctx.parsed.y.toFixed(2)
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (val) => '$' + val
          },
          grid: {color: '#F1F5F9'}
        },
        x: {
          grid: {display: false}
        }
      }
    }
  });

  // Top Sellers Chart
  const topAudits = {{{json topAudits}}};
  const topSellersCtx = document.getElementById('topSellersChart');
  
  new Chart(topSellersCtx, {
    type: 'doughnut',
    data: {
      labels: topAudits.map(a => a.name),
      datasets: [{
        data: topAudits.map(a => a.count),
        backgroundColor: [
          '#6366F1',
          '#10B981',
          '#F59E0B',
          '#3B82F6',
          '#8B5CF6'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {padding: 15}
        }
      }
    }
  });

  // Export function
  function exportTransactions() {
    // Create CSV content
    const purchases = {{{json purchases}}};
    
    let csv = 'Date,Report,Customer,Type,Amount,Status\n';
    
    purchases.forEach(p => {
      const date = new Date(p.createdAt).toLocaleDateString();
      const report = (p.auditId?.subject?.name || 'N/A').replace(/,/g, ';');
      const customer = (p.userId?.email || 'N/A').replace(/,/g, ';');
      const type = p.auditId?.auditClass === 'special_report' ? 'Special' : 'Placement';
      const amount = (p.pricePaid / 100).toFixed(2);
      
      csv += `${date},"${report}",${customer},${type},$${amount},Paid\n`;
    });

    // Download
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scoi-transactions-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }
</script>

</body>
</html>
