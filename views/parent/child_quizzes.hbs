{{!-- views/child_quizzes.hbs - MODERN REDESIGN --}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{child.firstName}}'s Learning Dashboard | CRIPFCnt</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  {{!-- Google Fonts --}}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#6366F1;
      --primary-light:#818CF8;
      --primary-dark:#4F46E5;
      --success:#10B981;
      --warning:#F59E0B;
      --danger:#EF4444;
      --info:#3B82F6;
      --purple:#8B5CF6;
      --pink:#EC4899;
      
      --bg:#0F172A;
      --surface:#1E293B;
      --surface-light:#334155;
      --border:#334155;
      --text:#F1F5F9;
      --text-muted:#94A3B8;
      
      --radius-sm:8px;
      --radius:12px;
      --radius-lg:16px;
      --radius-xl:20px;
      
      --shadow:0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg:0 10px 25px rgba(0,0,0,0.2);
      --shadow-xl:0 20px 40px rgba(0,0,0,0.3);
      
      --transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
    }

    body{
      font-family:'Plus Jakarta Sans',system-ui,sans-serif;
      background:linear-gradient(135deg,#0F172A 0%,#1E293B 100%);
      color:var(--text);
      line-height:1.6;
      min-height:100vh;
    }

    /* ============================================ */
    /* HEADER                                      */
    /* ============================================ */
    .header{
      background:rgba(30,41,59,0.8);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--border);
      padding:20px 0;
      position:sticky;
      top:0;
      z-index:100;
      animation:slideDown 0.5s ease;
    }

    @keyframes slideDown{
      from{transform:translateY(-100%);opacity:0}
      to{transform:translateY(0);opacity:1}
    }

    .header-container{
      max-width:1400px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      flex-wrap:wrap;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:16px;
    }

    .back-btn{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      color:var(--text-muted);
      text-decoration:none;
      font-weight:600;
      font-size:14px;
      transition:var(--transition);
    }

    .back-btn:hover{
      background:var(--surface-light);
      color:var(--text);
      transform:translateX(-4px);
    }

    .student-info{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .avatar{
      width:48px;
      height:48px;
      background:linear-gradient(135deg,var(--primary),var(--purple));
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:800;
      color:white;
      border:2px solid var(--border);
    }

    .student-details h1{
      font-size:22px;
      font-weight:800;
      margin-bottom:2px;
    }

    .student-details .grade-badge{
      display:inline-block;
      padding:2px 10px;
      background:rgba(99,102,241,0.1);
      border:1px solid rgba(99,102,241,0.3);
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      color:var(--primary-light);
    }

    .logout-btn{
      padding:10px 20px;
      background:var(--danger);
      color:white;
      border:none;
      border-radius:var(--radius);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
      transition:var(--transition);
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logout-btn:hover{
      background:#DC2626;
      transform:translateY(-2px);
    }

    /* ============================================ */
    /* MAIN CONTAINER                              */
    /* ============================================ */
    .container{
      max-width:1400px;
      margin:0 auto;
      padding:32px 24px;
    }

    /* ============================================ */
    /* STATS CARDS                                 */
    /* ============================================ */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:20px;
      margin-bottom:32px;
    }

    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:var(--transition);
    }

    .stat-card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
      border-color:var(--primary);
    }

    .stat-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:4px;
      background:linear-gradient(90deg,var(--primary),var(--purple));
    }

    .stat-icon{
      width:48px;
      height:48px;
      border-radius:var(--radius);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      margin-bottom:16px;
    }

    .stat-card.success .stat-icon{ background:rgba(16,185,129,0.1); }
    .stat-card.warning .stat-icon{ background:rgba(245,158,11,0.1); }
    .stat-card.info .stat-icon{ background:rgba(59,130,246,0.1); }
    .stat-card.purple .stat-icon{ background:rgba(139,92,246,0.1); }

    .stat-value{
      font-size:36px;
      font-weight:800;
      line-height:1;
      margin-bottom:8px;
    }

    .stat-card.success .stat-value{ color:var(--success); }
    .stat-card.warning .stat-value{ color:var(--warning); }
    .stat-card.info .stat-value{ color:var(--info); }
    .stat-card.purple .stat-value{ color:var(--purple); }

    .stat-label{
      font-size:13px;
      color:var(--text-muted);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    /* ============================================ */
    /* TABS                                        */
    /* ============================================ */
    .tabs-container{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:8px;
      margin-bottom:32px;
      display:flex;
      gap:8px;
      overflow-x:auto;
      scrollbar-width:none;
    }

    .tabs-container::-webkit-scrollbar{
      display:none;
    }

    .tab{
      flex:1;
      min-width:140px;
      padding:12px 20px;
      background:transparent;
      border:none;
      border-radius:var(--radius);
      color:var(--text-muted);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition:var(--transition);
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .tab:hover{
      background:var(--surface-light);
      color:var(--text);
    }

    .tab.active{
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      box-shadow:var(--shadow);
    }

    /* ============================================ */
    /* TAB CONTENT                                 */
    /* ============================================ */
    .tab-content{
      display:none;
      animation:fadeIn 0.4s ease;
    }

    .tab-content.active{
      display:block;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* ============================================ */
    /* QUIZ CARDS - MODERN GRID                    */
    /* ============================================ */
    .subject-section{
      margin-bottom:40px;
    }

    .subject-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      padding-bottom:12px;
      border-bottom:2px solid var(--border);
    }

    .subject-title{
      font-size:22px;
      font-weight:800;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:12px;
    }

    .subject-count{
      padding:4px 12px;
      background:rgba(99,102,241,0.1);
      border:1px solid rgba(99,102,241,0.3);
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      color:var(--primary-light);
    }

    .generate-btn{
      padding:10px 20px;
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      border:none;
      border-radius:var(--radius);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:var(--transition);
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      gap:6px;
    }

    .generate-btn:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }

    .generate-btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .quizzes-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:20px;
    }

    .quiz-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:var(--transition);
      cursor:pointer;
    }

    .quiz-card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-xl);
      border-color:var(--primary);
    }

    .quiz-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:4px;
      height:100%;
      background:linear-gradient(180deg,var(--primary),var(--purple));
    }

    .quiz-card.pending::before{ background:var(--warning); }
    .quiz-card.passed::before{ background:var(--success); }
    .quiz-card.failed::before{ background:var(--danger); }

    .quiz-header{
      margin-bottom:16px;
    }

    .quiz-title{
      font-size:17px;
      font-weight:700;
      color:var(--text);
      margin-bottom:8px;
      line-height:1.4;
    }

    .quiz-meta{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    .quiz-stat{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      color:var(--text-muted);
    }

    .quiz-stat .icon{
      font-size:14px;
    }

    .status-badge{
      padding:6px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .status-badge.pending{
      background:rgba(245,158,11,0.1);
      border:1px solid rgba(245,158,11,0.3);
      color:var(--warning);
    }

    .status-badge.passed{
      background:rgba(16,185,129,0.1);
      border:1px solid rgba(16,185,129,0.3);
      color:var(--success);
    }

    .status-badge.failed{
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      color:var(--danger);
    }

    .status-badge.practice{
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.3);
      color:var(--info);
    }

    .quiz-actions{
      display:flex;
      gap:10px;
    }

    .quiz-btn{
      flex:1;
      padding:12px;
      border:none;
      border-radius:var(--radius);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition:var(--transition);
      text-decoration:none;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .quiz-btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      box-shadow:var(--shadow);
    }

    .quiz-btn.primary:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }

    .quiz-btn.secondary{
      background:var(--surface-light);
      color:var(--text);
      border:1px solid var(--border);
    }

    .quiz-btn.secondary:hover{
      background:#475569;
    }

    /* ============================================ */
    /* PROGRESS VISUALIZATIONS                     */
    /* ============================================ */
    .chart-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(400px,1fr));
      gap:24px;
      margin-bottom:32px;
    }

    .chart-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:24px;
      box-shadow:var(--shadow);
    }

    .chart-title{
      font-size:18px;
      font-weight:800;
      color:var(--text);
      margin-bottom:20px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .chart-canvas{
      max-height:320px;
    }

    /* ============================================ */
    /* COMPLETION RING                             */
    /* ============================================ */
    .completion-container{
      display:flex;
      align-items:center;
      gap:32px;
      flex-wrap:wrap;
    }

    .ring-wrapper{
      position:relative;
      width:140px;
      height:140px;
      flex-shrink:0;
    }

    .ring-text{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      text-align:center;
    }

    .ring-text .percentage{
      font-size:32px;
      font-weight:800;
      background:linear-gradient(135deg,var(--success),var(--info));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    .ring-text .label{
      font-size:12px;
      color:var(--text-muted);
      font-weight:600;
    }

    .completion-stats{
      flex:1;
      min-width:200px;
    }

    .stat-row{
      display:flex;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid var(--border);
    }

    .stat-row:last-child{
      border-bottom:none;
    }

    .stat-row .label{
      color:var(--text-muted);
      font-size:14px;
    }

    .stat-row .value{
      font-weight:700;
      font-size:16px;
    }

    /* ============================================ */
    /* INSIGHT CARDS                               */
    /* ============================================ */
    .insight-card{
      background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));
      border:1px solid rgba(99,102,241,0.3);
      border-radius:var(--radius-lg);
      padding:24px;
      margin-top:24px;
    }

    .insight-card .icon{
      font-size:28px;
      margin-bottom:12px;
    }

    .insight-card strong{
      color:var(--primary-light);
    }

    /* ============================================ */
    /* EMPTY STATES                                */
    /* ============================================ */
    .empty-state{
      text-align:center;
      padding:60px 20px;
    }

    .empty-state .icon{
      font-size:64px;
      margin-bottom:20px;
      opacity:0.5;
    }

    .empty-state .title{
      font-size:22px;
      font-weight:800;
      margin-bottom:12px;
    }

    .empty-state .description{
      color:var(--text-muted);
      font-size:15px;
      max-width:500px;
      margin:0 auto;
      line-height:1.6;
    }

    /* ============================================ */
    /* KNOWLEDGE MAP BUTTON                        */
    /* ============================================ */
    .knowledge-map-cta{
      background:var(--surface);
      border:2px dashed var(--primary);
      border-radius:var(--radius-lg);
      padding:40px;
      text-align:center;
    }

    .knowledge-map-cta .icon{
      font-size:48px;
      margin-bottom:16px;
    }

    .knowledge-map-cta h3{
      font-size:24px;
      font-weight:800;
      margin-bottom:12px;
    }

    .knowledge-map-cta p{
      color:var(--text-muted);
      margin-bottom:24px;
      font-size:15px;
    }

    .knowledge-map-cta ul{
      list-style:none;
      text-align:left;
      max-width:400px;
      margin:20px auto 24px;
    }

    .knowledge-map-cta li{
      padding:8px 0;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:10px;
    }

    .knowledge-map-cta li::before{
      content:'‚úì';
      width:24px;
      height:24px;
      background:var(--primary);
      color:white;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:14px;
      flex-shrink:0;
    }

    /* ============================================ */
    /* RESPONSIVE                                  */
    /* ============================================ */
    @media(max-width:768px){
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
      }

      .quizzes-grid{
        grid-template-columns:1fr;
      }

      .chart-grid{
        grid-template-columns:1fr;
      }

      .subject-header{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }

      .completion-container{
        flex-direction:column;
      }

      .tabs-container{
        justify-content:flex-start;
      }

      .tab{
        min-width:120px;
      }
    }
  </style>
</head>

<body>

<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-container">
    <div class="header-left">
      {{#if isStudentView}}
        <a href="/student/dashboard" class="back-btn">
          ‚Üê Back
        </a>
      {{else}}
        <a href="/parent/dashboard" class="back-btn">
          ‚Üê Dashboard
        </a>
      {{/if}}

      <div class="student-info">
        <div class="avatar">{{substring child.firstName 0 1}}</div>
        <div class="student-details">
          <h1>{{child.firstName}} {{child.lastName}}</h1>
          <span class="grade-badge">Grade {{child.grade}}</span>
        </div>
      </div>
    </div>

    {{#if isStudentView}}
      <a href="/auth/logout" class="logout-btn">
        üö™ Sign Out
      </a>
    {{/if}}
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="container">

  <!-- STATS OVERVIEW -->
  <div class="stats-grid">
    <div class="stat-card success">
      <div class="stat-icon">üìä</div>
      <div class="stat-value">{{avgScore}}%</div>
      <div class="stat-label">Average Score</div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-value">{{passCount}}</div>
      <div class="stat-label">Quizzes Passed</div>
    </div>

    <div class="stat-card info">
      <div class="stat-icon">üìù</div>
      <div class="stat-value">{{totalPending}}</div>
      <div class="stat-label">Pending Quizzes</div>
    </div>

    <div class="stat-card purple">
      <div class="stat-icon">üèÜ</div>
      <div class="stat-value">{{certificates.length}}</div>
      <div class="stat-label">Certificates</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs-container">
    <button class="tab active" data-tab="assigned">
      üìö Assigned
    </button>
    <button class="tab" data-tab="practice">
      üîÑ Practice
    </button>
    <button class="tab" data-tab="history">
      üìú History
    </button>
    <button class="tab" data-tab="progress">
      üìà Progress
    </button>
    <button class="tab" data-tab="knowledge">
      üó∫Ô∏è Knowledge Map
    </button>
    <button class="tab" data-tab="certificates">
      üèÜ Certificates
    </button>
  </div>

  <!-- ================= ASSIGNED QUIZZES ================= -->
  <div id="assigned" class="tab-content active">
    {{#if quizzesBySubject}}
      {{#each quizzesBySubject}}
        <div class="subject-section">
          <div class="subject-header">
            <div>
              <h2 class="subject-title">
                {{#if (eq @key "math")}}üìê{{/if}}
                {{#if (eq @key "english")}}üìñ{{/if}}
                {{#if (eq @key "science")}}üî¨{{/if}}
                {{#if (eq @key "responsibility")}}ü§ù{{/if}}
                {{@key}}
                <span class="subject-count">{{this.length}} quiz{{#if (gt this.length 1)}}zes{{/if}}</span>
              </h2>
            </div>
            <button 
              class="generate-btn" 
              onclick="generatePracticeQuiz('{{@key}}', '{{../../child._id}}')"
            >
              ‚ö° Generate Practice
            </button>
          </div>

          <div class="quizzes-grid">
            {{#each this}}
              <div class="quiz-card pending">
                <div class="quiz-header">
                  <h3 class="quiz-title">{{quizTitle}}</h3>
                  <span class="status-badge pending">üìù Pending</span>
                </div>

                <div class="quiz-actions">
                  <a 
                    href="/lms/quiz?examId={{examId}}&org={{../../org.slug}}" 
                    class="quiz-btn primary"
                  >
                    ‚ñ∂ Start Quiz
                  </a>
                </div>
              </div>
            {{/each}}
          </div>
        </div>
      {{/each}}
    {{else}}
      <div class="empty-state">
        <div class="icon">üìö</div>
        <div class="title">No Quizzes Assigned Yet</div>
        <div class="description">
          Quizzes will appear here once they're assigned by your teacher or parent.
        </div>
      </div>
    {{/if}}
  </div>

  <!-- ================= PRACTICE MODE ================= -->
  <div id="practice" class="tab-content">
    {{#if practiceQuizzesBySubject}}
      {{#each practiceQuizzesBySubject}}
        <div class="subject-section">
          <div class="subject-header">
            <h2 class="subject-title">
              {{#if (eq @key "math")}}üìê{{/if}}
              {{#if (eq @key "english")}}üìñ{{/if}}
              {{#if (eq @key "science")}}üî¨{{/if}}
              {{#if (eq @key "responsibility")}}ü§ù{{/if}}
              {{@key}}
              <span class="subject-count">{{this.length}} available</span>
            </h2>
          </div>

          <div class="quizzes-grid">
            {{#each this}}
              <div class="quiz-card {{#if passed}}passed{{else}}failed{{/if}}">
                <div class="quiz-header">
                  <h3 class="quiz-title">{{quizTitle}}</h3>
                  {{#if passed}}
                    <span class="status-badge passed">‚úì Passed</span>
                  {{else}}
                    <span class="status-badge failed">‚ö† Needs Work</span>
                  {{/if}}
                </div>

                <div class="quiz-meta">
                  {{#if lastScore}}
                    <div class="quiz-stat">
                      <span class="icon">üéØ</span>
                      Best: {{lastScore}}%
                    </div>
                  {{/if}}
                  <div class="quiz-stat">
                    <span class="icon">üîÑ</span>
                    {{attemptCount}}x attempts
                  </div>
                </div>

                <div class="quiz-actions">
                  <a 
                    href="/lms/quiz?examId={{examId}}&org={{../../org.slug}}" 
                    class="quiz-btn primary"
                  >
                    üîÑ Practice Again
                  </a>
                </div>
              </div>
            {{/each}}
          </div>
        </div>
      {{/each}}

      <div class="insight-card">
        <div class="icon">üí°</div>
        <strong>Practice makes perfect!</strong> Each retry helps you master the material. 
        Your Knowledge Map updates with every attempt, showing your progress over time.
      </div>
    {{else}}
      <div class="empty-state">
        <div class="icon">üîÑ</div>
        <div class="title">No Completed Quizzes Yet</div>
        <div class="description">
          Complete quizzes from the <strong>Assigned Quizzes</strong> tab first, 
          then they'll appear here for practice and revision.
        </div>
      </div>
    {{/if}}
  </div>

  <!-- ================= HISTORY ================= -->
  <div id="history" class="tab-content">
    {{#if attempts.length}}
      <div class="quizzes-grid">
        {{#each attempts}}
          <div class="quiz-card {{#if passed}}passed{{else}}failed{{/if}}">
            <div class="quiz-header">
              <h3 class="quiz-title">{{quizTitle}}</h3>
              {{#if passed}}
                <span class="status-badge passed">‚úì {{percentage}}%</span>
              {{else}}
                <span class="status-badge failed">{{percentage}}%</span>
              {{/if}}
            </div>

            <div class="quiz-meta">
              <div class="quiz-stat">
                <span class="icon">üìÖ</span>
                {{formatDate finishedAt}}
              </div>
            </div>

            <div class="quiz-actions">
              {{#if isStudentView}}
                <a href="/org/{{../org.slug}}/my-attempts/{{_id}}" class="quiz-btn secondary">
                  üëÅÔ∏è Review
                </a>
              {{else}}
                <a href="/parent/children/{{../child._id}}/attempts/{{_id}}" class="quiz-btn secondary">
                  üëÅÔ∏è Review
                </a>
              {{/if}}
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="empty-state">
        <div class="icon">üìú</div>
        <div class="title">No Quiz History</div>
        <div class="description">
          Completed quizzes will appear here with scores and review options.
        </div>
      </div>
    {{/if}}
  </div>

  <!-- ================= PROGRESS ================= -->
  <div id="progress" class="tab-content">
    {{#if progressData.length}}
      
      <!-- Completion Ring -->
      <div class="chart-card">
        <h3 class="chart-title">üìã Quiz Completion</h3>
        <div class="completion-container">
          <div class="ring-wrapper">
            <canvas id="completionRing" width="140" height="140"></canvas>
            <div class="ring-text">
              <div class="percentage" id="ringPct">0%</div>
              <div class="label">Complete</div>
            </div>
          </div>
          <div class="completion-stats">
            <div class="stat-row">
              <span class="label">Completed</span>
              <span class="value" id="completedCount" style="color:var(--success)">0</span>
            </div>
            <div class="stat-row">
              <span class="label">Pending</span>
              <span class="value" id="pendingCount" style="color:var(--warning)">0</span>
            </div>
            <div class="stat-row">
              <span class="label">Total Assigned</span>
              <span class="value" id="totalCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="chart-grid">
        {{#if subjectChartData.length}}
          <div class="chart-card">
            <h3 class="chart-title">üìö Score by Subject</h3>
            <canvas id="subjectChart" class="chart-canvas"></canvas>
          </div>
        {{/if}}

        <div class="chart-card">
          <h3 class="chart-title">üìà Score Over Time</h3>
          <canvas id="lineChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Insights -->
      <div class="insight-card">
        <div class="icon">üí°</div>
        {{#if strongestSubject}}
          <strong>Strongest subject:</strong> {{strongestSubject}}.
        {{/if}}
        {{#if weakestSubject}}
          <strong>Needs attention:</strong> {{weakestSubject}} ‚Äî consider extra practice in this area.
        {{/if}}
        {{#unless weakestSubject}}
          {{#if strongestSubject}}
            Great work! All subjects are looking solid. Keep up the momentum.
          {{/if}}
        {{/unless}}
      </div>

    {{else}}
      <div class="empty-state">
        <div class="icon">üìä</div>
        <div class="title">No Progress Data Yet</div>
        <div class="description">
          Progress analytics will appear here once quizzes are completed.
        </div>
      </div>
    {{/if}}
  </div>

  <!-- ================= KNOWLEDGE MAP ================= -->
  <div id="knowledge" class="tab-content">
    <div class="knowledge-map-cta">
      <div class="icon">üó∫Ô∏è</div>
      <h3>Learning Progress by Topic</h3>
      <p>See which topics {{child.firstName}} has mastered and which need more practice</p>

      <ul>
        <li>Topic-by-topic mastery levels</li>
        <li>Color-coded progress tracking</li>
        <li>Personalized practice quiz generation</li>
        <li>Difficulty progression tracking</li>
      </ul>

      <a 
        href="/parent/children/{{child._id}}/knowledge-map" 
        class="quiz-btn primary"
        style="max-width:300px;margin:0 auto;"
      >
        üìä View Full Knowledge Map
      </a>
    </div>
  </div>

  <!-- ================= CERTIFICATES ================= -->
  <div id="certificates" class="tab-content">
    {{#if certificates.length}}
      <div class="quizzes-grid">
        {{#each certificates}}
          <div class="quiz-card passed">
            <div class="quiz-header">
              <h3 class="quiz-title">{{quizTitle}}</h3>
              <span class="status-badge passed">üèÜ {{percentage}}%</span>
            </div>

            <div class="quiz-meta">
              <div class="quiz-stat">
                <span class="icon">üìÖ</span>
                {{formatDate createdAt}}
              </div>
            </div>

            <div class="quiz-actions">
              <a 
                href="/admin/certificates/{{_id}}/download/pdf" 
                target="_blank"
                class="quiz-btn primary"
              >
                üì• Download Certificate
              </a>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="empty-state">
        <div class="icon">üèÜ</div>
        <div class="title">No Certificates Yet</div>
        <div class="description">
          Certificates will appear here when quizzes are passed with high scores.
        </div>
      </div>
    {{/if}}
  </div>

</main>

<!-- ================= SCRIPTS ================= -->
<script>
  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // Data from server
  const progressData = {{{json progressData}}};
  const subjectChartData = {{{json subjectChartData}}};
  const passCount = {{passCount}};
  const failCount = {{failCount}};
  const totalCompleted = passCount + failCount;
  const totalPending = {{{json totalPending}}};
  const totalAssigned = totalCompleted + totalPending;
  const completionPct = totalAssigned > 0 ? Math.round((totalCompleted / totalAssigned) * 100) : 0;

  // Update completion stats
  document.getElementById('ringPct').textContent = completionPct + '%';
  document.getElementById('completedCount').textContent = totalCompleted;
  document.getElementById('pendingCount').textContent = totalPending;
  document.getElementById('totalCount').textContent = totalAssigned;

  // Completion Ring
  const ringCtx = document.getElementById('completionRing');
  if (ringCtx) {
    new Chart(ringCtx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Pending'],
        datasets: [{
          data: [totalCompleted, totalPending],
          backgroundColor: ['#10B981', '#475569'],
          borderWidth: 0,
          cutout: '75%'
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  }

  // Subject Bar Chart
  if (subjectChartData.length) {
    const subjectCtx = document.getElementById('subjectChart');
    if (subjectCtx) {
      const colors = subjectChartData.map(s =>
        s.avg >= 80 ? '#10B981' : s.avg >= 60 ? '#F59E0B' : '#EF4444'
      );

      new Chart(subjectCtx, {
        type: 'bar',
        data: {
          labels: subjectChartData.map(s => s.subject),
          datasets: [{
            label: 'Average Score %',
            data: subjectChartData.map(s => s.avg),
            backgroundColor: colors,
            borderRadius: 8,
            barThickness: 40
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              min: 0,
              max: 100,
              grid: { color: '#334155' },
              ticks: { 
                color: '#94A3B8',
                callback: v => v + '%'
              }
            },
            y: {
              grid: { display: false },
              ticks: { 
                color: '#F1F5F9',
                font: { weight: 700 }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.x + '%'
              }
            }
          }
        }
      });
    }
  }

  // Score Over Time Line Chart
  if (progressData.length) {
    const lineCtx = document.getElementById('lineChart');
    if (lineCtx) {
      const sorted = [...progressData].sort((a, b) => new Date(a.date) - new Date(b.date));
      const labels = sorted.map((p, i) => {
        const d = new Date(p.date);
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      });
      const scores = sorted.map(p => p.score);

      new Chart(lineCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Score %',
            data: scores,
            borderColor: '#6366F1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: scores.map(s =>
              s >= 80 ? '#10B981' : s >= 60 ? '#F59E0B' : '#EF4444'
            ),
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 100,
              grid: { color: '#334155' },
              ticks: { 
                color: '#94A3B8',
                callback: v => v + '%'
              }
            },
            x: {
              grid: { color: '#334155' },
              ticks: { color: '#94A3B8' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => 'Score: ' + ctx.parsed.y + '%'
              }
            }
          }
        }
      });
    }
  }

  // Practice Quiz Generation
  async function generatePracticeQuiz(subject, childId) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating...';

    try {
      const response = await fetch(`/parent/children/${childId}/generate-practice-quiz`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject: subject.toLowerCase() })
      });

      const data = await response.json();

      if (data.success && data.quizId) {
        window.location.href = data.redirectUrl;
      } else {
        alert('Failed to generate quiz. Please try again.');
        btn.disabled = false;
        btn.textContent = '‚ö° Generate Practice';
      }
    } catch (error) {
      console.error('Error generating quiz:', error);
      alert('Error generating quiz. Please try again.');
      btn.disabled = false;
      btn.textContent = '‚ö° Generate Practice';
    }
  }
</script>

</body>
</html>
